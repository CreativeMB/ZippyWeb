<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ZippyWeb</title>
 <link rel="icon" href="favicon.ico" type="image/x-icon">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
    body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    min-height: 100vh;
    display: flex;

    background: linear-gradient(
        to bottom,
        rgba(74, 173, 78, 0.34),
        rgba(0, 150, 136, 0.90)
    );
}

    /* Barra lateral a la derecha con fondo negro */
#sidebar {
    width: 25%;
    background: #000; /* fondo negro */
    color: #fff; /* texto blanco */
    padding: 15px;
    overflow-y: auto;
    box-sizing: border-box;
    border-left: 2px solid #444; /* en lugar de border-right */
    border-right: none;
    position: fixed; /* fijar al lado derecho */
    top: 0;
    right: 0; /* mover al lado derecho */
    height: 100vh;
}

/* Cambiar estilos de lista dentro de la sidebar */
#sidebar li {
    padding: 10px;
    background: #111; /* ligeramente m√°s claro que el negro */
    margin-bottom: 8px;
    cursor: pointer;
    border-radius: 6px;
    transition: 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

#sidebar li:hover {
    background: #222;
}

/* Botones dentro de la barra */
#sidebar button {
    margin: 5px 0;
    padding: 10px;
    width: 100%;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 16px;
    background: #333;
    color: #fff;
    transition: 0.2s;
}

#sidebar button:hover {
    background: #555;
}

/* Ajustar el main para que no quede tapado */
#main {
    margin-right: 25%; /* dejar espacio para la sidebar */
    padding: 15px;
     width: calc(100% - 25%);
}

   /* Tabla */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
th, td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: left;
    font-size: 16px;
}
th {
    background: #eee;
}

/* Formulario estilo card */
#formNuevoDato {
    display: none; /* Oculto hasta abrir */
    margin: 15px 0;
    padding: 20px;
    background: #1c1c1c; /* Fondo oscuro para resaltar inputs */
    border-radius: 12px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
    position: relative;
    color: #fff; /* Texto claro sobre fondo oscuro */
}

/* Inputs y textarea */
#formNuevoDato input,
#formNuevoDato textarea {
    width: 100%;
    margin-bottom: 15px;
    padding: 15px;
    font-size: 16px;
    border: 2px solid #555;
    border-radius: 10px;
    box-sizing: border-box;
    transition: all 0.3s ease;
    background-color: #2c2c2c; /* Fondo oscuro input */
    color: #fff;
}

#formNuevoDato input:focus,
#formNuevoDato textarea:focus {
    border-color: #4a90e2;
    box-shadow: 0 0 10px rgba(74,144,226,0.5);
    outline: none;
    background-color: #333;
}

#formNuevoDato textarea {
    min-height: 80px;
    resize: vertical;
}

/* Bot√≥n m√°s opciones */
#btnMasOpciones {
    width: 100%;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: none;
    background-color: #FFC107;
    color: #333;
    font-size: 16px;
    cursor: pointer;
    transition: 0.2s;
}
#btnMasOpciones:hover {
    background-color: #FFB300;
}

/* Opciones extra */
#opcionesExtra {
    display: none;
    margin-bottom: 15px;
    padding: 10px;
    background-color: #2a2a2a;
    border-radius: 8px;
}

#opcionesExtra label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
    margin-bottom: 10px;
    color: #fff; /* Asegura visibilidad del texto */
}

#opcionesExtra input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
}

/* Botones de guardar/cancelar */
#formNuevoDato .botones {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

#formNuevoDato button.guardar,
#formNuevoDato button.cancelar {
    flex: 1;
    padding: 15px;
    font-size: 16px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: 0.2s;
}

#formNuevoDato button.guardar {
    background-color: #4CAF50;
    color: #fff;
}
#formNuevoDato button.guardar:hover {
    background-color: #45a049;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

#formNuevoDato button.cancelar {
    background-color: #f44336;
    color: #fff;
}
#formNuevoDato button.cancelar:hover {
    background-color: #e53935;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

    /* Sugerencias */
    #suggestions {
        position: absolute;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        max-height: 120px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    #suggestions div:hover { background: #eee; cursor: pointer; }
    /* ================= CONTENEDOR GRID ================= */
/* CONTENEDOR GRID */
#pedidosGrid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* m√°s flexible para pantallas medianas */
    gap: 10px;          /* separaci√≥n visible entre tarjetas */
    padding: 1px 0;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}
/* TARJETAS */
.pedido-card {
    border-radius: 14px;
    padding: 10px;  /* espacio interno reducido a 2px */
    display: flex;
    flex-direction: column;
    gap: 2px;      /* espacio entre elementos internos */
}

/* PARTE SUPERIOR */
.pedido-top {
    display: flex;
    gap: 2px;
    align-items: flex-start;
}

/* IMAGE */
.pedido-img {
    width: 110px;
    height: 160px;
    object-fit: contain;
    background: #fff;
    border-radius: 10px;
    flex-shrink: 0;
}

/* PARTE INFERIOR */
.pedido-bottom {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-top: 2px; /* margen entre top y bottom */
}

/* TEXTO COMPACTO */
.linea {
    font-size: 13px;
    line-height: 1.2;
    margin: 0;
    padding: 0;
}

/* BODY */
.pedido-body p,
.pedido-body h4 {
    margin: 2px 0;
}

/* TITULO */
.pedido-body h4 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
}

.pedido-info {
    font-size: 16px; /* ajusta al tama√±o que quieras */
     font-weight: bold;
}
.pedido-info .linea,
.pedido-info .sub-linea,
.pedido-info .linea.ref {
    font-size: inherit; /* hereda el tama√±o del contenedor principal */
}


/* MENSAJE LARGO */
.mensaje {
    font-size: 12.5px;
    white-space: pre-wrap;
}

/* FOOTER */
.pedido-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 1px 0; /* margen superior e inferior */
    font-size: 11px;
}

/* COLOR */
.color-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

/* RESPONSIVE */
@media (max-width: 600px) {
    .pedido-card {
        flex-direction: column;
    }

    .pedido-img {
        width: 100%;
        height: 220px;
    }
}

/* SEPARADOR DE FECHA */
.fecha-header {
    grid-column: 1 / -1;
    font-weight: 600;
    font-size: 15px;
    margin: 2px 0; /* margen arriba y abajo de 2px */
    padding: 6px 10px; /* padding reducido */
    background: #f5f5f5;
    border-radius: 8px;
}

.maps-link {
    color: #0c6eee;      /* azul Google */
    text-decoration: none;
    font-weight: normal;
}

.maps-link:hover {
    text-decoration: underline;
}

.domiciliario-linea {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
}

.domi-select {
    font-size: 14px;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #fff;
}

.domi-telefono {
    font-size: 13px;
}

.resumen-oculto {
    display: none;
}

/* === RESUMEN === */
#resumenTotales {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin: 12px 0;
}

/* tarjetas */
#resumenTotales .total {
    padding: 10px;
    border-radius: 12px;
    text-align: center;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

#resumenTotales .label {
    display: block;
    font-size: 12px;
    opacity: 0.85;
    margin-bottom: 4px;
}

/* colores */
.total.positivo { background:#E8F5E9; color:#2E7D32; }
.total.negativo { background:#FFEBEE; color:#C62828; }
.total.diferencia { background:#E3F2FD; color:#1565C0; }

/* botones */
.acciones {
    display: flex;
    gap: 8px;
}

.acciones button {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
}

/* =========================
   MODAL DE IMPRESI√ìN
========================= */
.print-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}


.print-contenido {
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    width: 320px;
    max-height: 90vh;
    overflow: auto;
}

.print-botones {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}

.print-botones button {
    padding: 8px 14px;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
}

/* =========================
   TARJETA IMPRESI√ìN BASE
========================= */
.tarjeta-impresion {
    overflow: hidden;
    width: 101.6mm;          /* 4 pulgadas */
    height: 152.4mm;         /* 6 pulgadas */
    padding: 10mm;
    box-sizing: border-box;
    background: #fdfcf8;      /* fondo crema elegante */
    font-family: 'Georgia', serif;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    border: none;
    position: relative;
    color: #2c2c2c;           /* texto oscuro elegante */
}
/* =========================
   MENSAJE PRINCIPAL
========================= */
.mensaje-principal {
    flex: 1;                              
    font-family: 'Great Vibes', cursive;  
    display: flex;
    justify-content: center; /* centra horizontalmente */
    align-items: center;     /* centra verticalmente */
    text-align: center;
    line-height: 1.2;
    white-space: pre-wrap;                 
    overflow-wrap: break-word;             
    color: #2c2c2c;                       
    height: 100%;            /* ocupar todo el alto de la tarjeta */
    margin: 0;               /* eliminar m√°rgenes extra */
    overflow: hidden;        /* cortar si algo sobra */
    padding: 2px;            /* opcional: un poco de espacio interno */
}
/* =========================
   DE / PARA
========================= */
.de-para {
    margin-top: 2mm; /* antes era 6mm, ahora m√°s pegado */
    font-size: 18px;
    text-align: center;
}

.de-para div {
    margin-top: 1mm; /* antes 2mm, m√°s compacto */
}


/* =========================
   DECORACI√ìN INFERIOR
========================= */
.decoracion {
    text-align: center;
    font-size: 20px;
    margin-top: 6mm;
    color: #8b0000;           /* rojo elegante */
}

/* =========================
   VISTA PREVIA (SOLO PANTALLA)
========================= */
.print-contenido {
    width: 90vw;
    max-width: 900px;
}

.print-area-horizontal {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 10px;
}
/* =========================
   TARJETA HORIZONTAL SOLO EN PANTALLA
========================= */
@media screen {
    .print-area-horizontal .tarjeta-impresion {
        overflow: hidden;
       padding-left: 38mm;
        width: 152.4mm;  /* 6 pulgadas */
        height: 101.6mm; /* 4 pulgadas */
        margin: auto;    /* Centrar en pantalla */
        box-sizing: border-box;
        border: 1px solid #008558;
    }
}
/* =========================
   Logo como fondo flotante proporcional
========================= */
.logo-empresa {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;          /* de arriba a abajo */
    z-index: 0;            /* detr√°s del contenido */
    pointer-events: auto;
    overflow: hidden;
}

/* Imagen del logo */
.logo-empresa img {
    height: 100%;          /* ocupa todo el alto */
    width: auto;           /* ancho proporcional */
    max-width: none;
    object-fit: contain;   /* NO se deforma */
    display: block;
}

/* Placeholder */
.logo-empresa .placeholder {
    position: absolute;
    inset: 0;
    z-index: 1;
    font-size: 9px;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
}
.mensaje-principal,
.de-para,
.decoracion {
    position: relative;
    z-index: 2;
}

/* =========================
   IMPRESI√ìN DE PARA
========================= */
.opciones-impresion {
    margin-bottom: 10px;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 8px;
    font-size: 14px;
}

.opciones-impresion label {
    margin-right: 15px;
    cursor: pointer;
}

.nota-impresion {
    margin-top: 8px;
    font-size: 13px;
    color: #444;
    line-height: 1.4;
}


/* =========================
   IMPRESI√ìN REAL 4x6
========================= */
@media print {
    body * {
        visibility: hidden; /* oculta todo */
    }

    #printArea, #printArea * {
        visibility: visible; /* solo mostrar el √°rea de impresi√≥n */
    }

    #printArea {
    
        position: fixed; /* evita repetici√≥n */
        top: 0;
        left: 0;
        width: 152.4mm;
        height: 101.6mm;
        margin: 0;
        box-sizing: border-box;
        border: none;      /* quita cualquier borde */
        box-shadow: none;  /* quita sombras si hab√≠a */
    }

    .tarjeta-impresion {
       padding-left: 38mm;
        width: 152.4mm;
        height: 101.6mm;
    }
}
/* =========================
   En Ruta
========================= */
.pedido-card {
    position: relative;
    overflow: hidden;
}

.etiqueta-ruta {
    position: absolute;
    top: -6px;
    right: -52px;
    transform: rotate(45deg);

    width: 140px;              /* üëà cubre hasta la esquina */
    height: 48px;              /* alto suficiente para 2 l√≠neas */

    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: #fff;

    font-size: 14px;
    font-weight: 900;
    text-transform: uppercase;

    display: none;
    flex-direction: column;    /* üëà texto en 2 l√≠neas */
    align-items: center;
    justify-content: center;

    line-height: 1.1;
    box-shadow: 0 3px 8px rgba(0,0,0,.35);
    z-index: 10;
}

.pedido-card.en-ruta .etiqueta-ruta {
    display: flex;
}

.switch-ruta {
    display: inline-flex;
    align-items: center;
    margin-left: 6px;
    cursor: pointer;
    font-size: 14px;
}

</style>
</head>
<body>

<div id="sidebar">
       <button id="btnCerrarSesion" style="margin-bottom:5px; padding:8px 10px; font-size:16px;">üö™ Cerrar Sesi√≥n</button>
    <h3 id="sidebarTitulo">üìÇ Contabilidad</h3>
   <div id="resumenTotales" class="resumen-oculto">
    <div class="total positivo">
        <span class="label">Ingresos</span>
        <span id="totalPositivo">$0</span>
    </div>

    <div class="total negativo">
        <span class="label">Gastos</span>
        <span id="totalNegativo">$0</span>
    </div>

    <div class="total diferencia">
        <span class="label">Balance</span>
        <span id="totalDiferencia">$0</span>
    </div>
</div>

<div class="acciones">
    <button id="btnVolver" style="display:none;">‚¨ÖÔ∏è Volver</button>
    <button id="btnAgregarDato" style="display:none;">‚ûï Nuevo Producto</button>
</div>


    <button id="btnVolver" style="display:none;">‚¨ÖÔ∏è Volver</button>
    <button id="btnAgregarDato" style="display:none;">‚ûï Nuevo Producto</button>

    <div id="formNuevoDato">
        <input type="number" id="inputValor" placeholder="üí∞ Precio">
        <input type="text" id="inputNombre" placeholder="üìù Nombre">
        <div id="opcionesExtra">
            <label><input type="checkbox" id="inputNegativo"> Negativo</label>
            <textarea id="inputNota" placeholder="üóíÔ∏è Nota o descripci√≥n"></textarea>
        </div>
        <div class="botones">
            <button id="btnGuardarDato" class="guardar">Guardar</button>
            <button id="btnCancelarDato" class="cancelar">Cancelar</button>
            <button type="button" id="btnMasOpciones">‚öôÔ∏è M√°s opciones</button>
        </div>
    </div>

    <ul id="sidebarList"></ul>
</div>

<div id="main">
 
     <!-- ================= PEDIDOS ================= -->
<div id="pedidos-container">

    <!-- Grid responsive -->
    <div id="pedidosGrid"></div>

</div>

</div>

<div id="printModal" class="print-modal">
    <div class="print-contenido horizontal">

        <h3>üñ® Vista previa de impresi√≥n</h3>
         <!-- OPCIONES DE IMPRESI√ìN -->
        <div class="opciones-impresion">
            <label>
                <input type="checkbox" id="chkPara" checked>
                Mostrar Para
            </label>

            <label>
                <input type="checkbox" id="chkDe" checked>
                Mostrar De
            </label>

            <p class="nota-impresion">
                ‚ö†Ô∏è <strong>Importante: Tama√±o papel 4 √ó 6 pulgadas (10.16 √ó 15.24 cm) </strong><br>
                Configura tu impresora en tama√±o  
                <strong>4 √ó 6 pulgadas (10.16 √ó 15.24 cm)</strong>  
                de forma horizontal y desactiva cualquier opci√≥n de ajuste autom√°tico o escalado.
            </p>
        </div>

        <div id="printArea" class="print-area-horizontal">
            <!-- Tarjeta se carga aqu√≠ -->
        </div>

        <div class="print-botones">
            <button onclick="imprimirTarjeta()">üñ® Imprimir</button>
            <button onclick="cerrarPrint()">‚ùå Cancelar</button>
        </div>

    </div>
</div>


<script>
const firebaseConfig = {
    apiKey: "AIzaSyBTphfyjQbU1AKt6sYFepJ8Q8mGp3sbtOA",
    authDomain: "zippy-727d5.firebaseapp.com",
    databaseURL: "https://zippy-727d5-default-rtdb.firebaseio.com",
    projectId: "zippy-727d5"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let idEmpresa = null;
let baseSeleccionada = null;
let referenciasDrive = {};

const sidebarList = document.getElementById("sidebarList");
const sidebarTitulo = document.getElementById("sidebarTitulo");
const btnVolver = document.getElementById("btnVolver");
const btnAgregarDato = document.getElementById("btnAgregarDato");
const formNuevoDato = document.getElementById("formNuevoDato");
const inputNombre = document.getElementById("inputNombre");
const inputValor = document.getElementById("inputValor");
const inputNegativo = document.getElementById("inputNegativo");
const inputNota = document.getElementById("inputNota");
const btnGuardarDato = document.getElementById("btnGuardarDato");
const btnCancelarDato = document.getElementById("btnCancelarDato");
const btnCerrarSesion = document.getElementById("btnCerrarSesion");
const btnMasOpciones = document.getElementById("btnMasOpciones");
const opcionesExtra = document.getElementById("opcionesExtra");

// --- M√°s opciones ---
btnMasOpciones.onclick = () => {
    opcionesExtra.style.display = opcionesExtra.style.display === "none" ? "block" : "none";
};

// --- CERRAR SESI√ìN ---
btnCerrarSesion.onclick = () => {
    if(confirm("¬øEst√° seguro que desea cerrar sesi√≥n?")){
        auth.signOut().then(()=> window.location.href="login.html")
        .catch(err => alert("Error cerrando sesi√≥n: " + err.message));
    }
};

// --- AUTH ---
auth.onAuthStateChanged(user => {
    if (!user) {
        window.location.href = "login.html";
    } else {
        idEmpresa = user.uid;

        cargarPerfilEmpresa();
        cargarBases();

        cargarReferenciasDesdeFirebase().then(() => {
            cargarPedidosRealtime();
        });
    }
});


// Funci√≥n para cargar el perfil de la empresa
function cargarPerfilEmpresa() {
    const ref = db.ref(`${idEmpresa}/perfilempresa`);
    ref.once('value').then(snapshot => {
        const perfil = snapshot.val();
        if (!perfil) return;

        window.perfilEmpresa = perfil;
        const resumenEmpresa = document.getElementById('resumenEmpresa');
        if (resumenEmpresa) {
            resumenEmpresa.textContent = `${perfil.nombreEmpresa} ¬∑ WhatsApp: ${perfil.WhatsApp}`;
        }
    }).catch(err => {
        console.error("Error cargando perfil de empresa:", err);
    });
}

// --- CARGAR BASES ---
function cargarBases() {
    document.getElementById('resumenTotales').style.display = 'none';
    sidebarTitulo.textContent = "üìÇ Contabilidad";
    btnVolver.style.display = "none";
    btnAgregarDato.style.display = "none";
    formNuevoDato.style.display = "none";
    opcionesExtra.style.display = "none";

    sidebarList.innerHTML = '';

    const ref = db
        .ref(`${idEmpresa}/basededatos`)
        .orderByChild('timestamp')
        .limitToLast(100);

    ref.on('child_added', snap => {
        if (!snap.exists()) return;

        const li = document.createElement('li');
        li.textContent = snap.key;
        li.onclick = () => mostrarDatos(snap.key);

        // üî• M√ÅS RECIENTE ARRIBA
        sidebarList.insertBefore(li, sidebarList.firstChild);
    });
}


// --- BOTONES ---
btnVolver.onclick = () => {
    document.getElementById('resumenTotales').style.display = 'none';
    cargarBases();
};


btnAgregarDato.onclick = () => {
    if(baseSeleccionada){
        formNuevoDato.style.display = "block";
        inputValor.focus();
    }
};

btnCancelarDato.onclick = () => {
    formNuevoDato.style.display = "none";
    opcionesExtra.style.display = "none";
    inputNombre.value = "";
    inputValor.value = "";
    inputNegativo.checked = false;
    inputNota.value = "";
};

// Guardar llama a la funci√≥n √∫nica que escribe en Firebase
btnGuardarDato.onclick = () => {
    guardarDato();
};


// --- TECLAS ---
document.addEventListener('keydown', e => {
    if(e.key === "F2"){ 
        if(!baseSeleccionada) return;
        formNuevoDato.style.display = "block";
        inputValor.focus();
        e.preventDefault();
    }
});

// Enter entre campos
[inputValor, inputNombre, inputNota].forEach((input,index,arr)=>{
    input.addEventListener('keydown', e=>{
        if(e.key==="Enter"){
            e.preventDefault();
            if(index < arr.length-1) arr[index+1].focus();
            else guardarDato();
        }
    });
});

// --- FUNCION MOSTRAR DATOS DE BASE ---
function mostrarDatos(base) {
    baseSeleccionada = base;

    sidebarTitulo.textContent = `üìÑ Datos de: ${base}`;
    btnVolver.style.display = "inline-block";
    btnAgregarDato.style.display = "inline-block";
    formNuevoDato.style.display = "none";
    opcionesExtra.style.display = "none";

    // üëâ MOSTRAR resumen SOLO al entrar a la base
    const resumen = document.getElementById('resumenTotales');
    resumen.style.display = 'grid';

    const ref = db.ref(`${idEmpresa}/basededatos/${base}`);
    ref.off();
    sidebarList.innerHTML = '';

    const itemsMostrados = new Set();

    // Totales
    let totalPositivo = 0;
    let totalNegativo = 0;

    /* ===================== üîµ CARGA INICIAL ===================== */
    ref.once('value', snapshot => {
        const itemsArray = [];

        snapshot.forEach(itemSnap => {
            const item = itemSnap.val();
            if (item && item.nombre) {
                itemsArray.push({ ...item, key: itemSnap.key });
            }
        });

        // Ordenar por fecha (m√°s reciente primero)
        itemsArray.sort((a, b) => new Date(b.fechaHora) - new Date(a.fechaHora));

        itemsArray.forEach(item => {
            itemsMostrados.add(item.key);

            const valor = Number(item.valor) || 0;
            if (valor > 0) totalPositivo += valor;
            if (valor < 0) totalNegativo += valor;

            const li = document.createElement('li');
            li.dataset.key = item.key;

            const fechaFormateada = formatearFechaBD(item.fechaHora);
            const valorTexto = `$${valor.toLocaleString('es-CO')}`;

            li.textContent = `${item.nombre} : ${valorTexto} ${fechaFormateada}`;

            if (valor < 0) {
                li.style.color = '#D32F2F';
                li.style.backgroundColor = '#FFCDD2';
            } else {
                li.style.color = '#388E3C';
                li.style.backgroundColor = '#C8E6C9';
            }

            li.style.padding = '10px';
            li.style.marginBottom = '5px';
            li.style.borderRadius = '6px';

            sidebarList.appendChild(li);
        });

        // üëâ actualizar resumen inicial
        actualizarTotales(totalPositivo, totalNegativo);
    });

    /* ===================== üî¥ TIEMPO REAL ===================== */
    ref.on('child_added', itemSnap => {
        if (itemsMostrados.has(itemSnap.key)) return;

        const item = itemSnap.val();
        if (!item || !item.nombre) return;

        itemsMostrados.add(itemSnap.key);

        const valor = Number(item.valor) || 0;
        if (valor > 0) totalPositivo += valor;
        if (valor < 0) totalNegativo += valor;

        const li = document.createElement('li');
        li.dataset.key = itemSnap.key;

        const fechaFormateada = formatearFechaBD(item.fechaHora);
        const valorTexto = `$${valor.toLocaleString('es-CO')}`;

        li.textContent = `${item.nombre} : ${valorTexto} ${fechaFormateada}`;

        if (valor < 0) {
            li.style.color = '#D32F2F';
            li.style.backgroundColor = '#FFCDD2';
        } else {
            li.style.color = '#388E3C';
            li.style.backgroundColor = '#C8E6C9';
        }

        li.style.padding = '10px';
        li.style.marginBottom = '5px';
        li.style.borderRadius = '6px';

        sidebarList.insertBefore(li, sidebarList.firstChild);

        // üëâ actualizar resumen en tiempo real
        actualizarTotales(totalPositivo, totalNegativo);
    });
}

// --- FUNCION GUARDAR DATO ---
function guardarDato() {
    const nombre = inputNombre.value.trim();
    let valor = parseFloat(inputValor.value);
    const negativo = inputNegativo.checked;
    const nota = inputNota.value.trim();

    if(!nombre || isNaN(valor)){ alert("Nombre y valor son requeridos"); return; }
    if(negativo) valor = -Math.abs(valor);

    const ref = db.ref(`${idEmpresa}/basededatos/${baseSeleccionada}`);
    const newKey = ref.push().key;

    const ahora = new Date();
    const fechaHora = `${ahora.getFullYear()}-${String(ahora.getMonth()+1).padStart(2,'0')}-${String(ahora.getDate()).padStart(2,'0')} ${String(ahora.getHours()).padStart(2,'0')}:${String(ahora.getMinutes()).padStart(2,'0')}`;

    ref.child(newKey).set({
        id: newKey,
        fechaHora,
        nombre,
        valor,
        nota: nota || ""
    }).then(() => {
        // Limpiar formulario
        inputNombre.value = "";
        inputValor.value = "";
        inputNegativo.checked = false;
        inputNota.value = "";
        formNuevoDato.style.display = "none";
        opcionesExtra.style.display = "none";

        // El listener de Firebase se encargar√° de agregar el item autom√°ticamente al DOM
    }).catch(err => alert("Error guardando dato: " + err.message));
}



function mostrarItemsConColores(items) {
    sidebarList.innerHTML = ''; // limpiar lista
    items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.nombre} - ${item.valor} (${item.fechaHora})`;

        // Colores seg√∫n valor
        if(item.valor < 0){
            li.style.color = '#D32F2F'; // rojo para negativos
            li.style.backgroundColor = '#FFCDD2'; // fondo rojo claro
        } else {
            li.style.color = '#388E3C'; // verde para positivos
            li.style.backgroundColor = '#C8E6C9'; // fondo verde claro
        }

        li.style.padding = '10px';
        li.style.marginBottom = '5px';
        li.style.borderRadius = '6px';

        sidebarList.appendChild(li);
    });
}



// --- AUTOCOMPLETADO Y ENTER PARA GUARDAR ---
const suggestionsContainer = document.createElement('div');
suggestionsContainer.id='suggestions';
suggestionsContainer.style.position='absolute';
suggestionsContainer.style.background='#fff';
suggestionsContainer.style.border='1px solid #ccc';
suggestionsContainer.style.borderRadius='6px';
suggestionsContainer.style.maxHeight='120px';
suggestionsContainer.style.overflowY='auto';
suggestionsContainer.style.zIndex='1000';
document.body.appendChild(suggestionsContainer);

function posicionarSugerencias(){
    const rect = inputNombre.getBoundingClientRect();
    suggestionsContainer.style.top = rect.bottom + window.scrollY + 'px';
    suggestionsContainer.style.left = rect.left + window.scrollX + 'px';
    suggestionsContainer.style.width = rect.width + 'px';
}

// --- AUTOCOMPLETADO INLINE (solo completa el input) ---
inputNombre.addEventListener('input', () => {
    const query = inputNombre.value.trim().toLowerCase();
    if(query.length < 2) return;

    const ref = db.ref(`${idEmpresa}/basededatos/${baseSeleccionada}`);
    ref.once('value', snapshot => {
        let primeraCoincidencia = null;
        snapshot.forEach(itemSnap => {
            const item = itemSnap.val();
            if(item && item.nombre && item.nombre.toLowerCase().startsWith(query) && !primeraCoincidencia){
                primeraCoincidencia = item.nombre;
            }
        });

        if(primeraCoincidencia){
            inputNombre.value = primeraCoincidencia;
            inputNombre.setSelectionRange(query.length, primeraCoincidencia.length);
        }
    });
});


// ENTER en Valor pasa a Nombre
inputValor.addEventListener('keydown', e=>{
    if(e.key === "Enter"){
        e.preventDefault();
        inputNombre.focus();
    }
});

// ENTER en Nombre selecciona la primera sugerencia o guarda el dato
inputNombre.addEventListener('keydown', e=>{
    if(e.key === "Enter"){
        e.preventDefault();
        if(suggestionsContainer.firstChild){
            inputNombre.value = suggestionsContainer.firstChild.textContent;
            suggestionsContainer.style.display='none';
        }
        guardarDato(); // Guardar inmediatamente sin tocar botones
    }
});

// Cerrar sugerencias al hacer clic fuera
document.addEventListener('click', (e)=>{
    if(!formNuevoDato.contains(e.target)){
        suggestionsContainer.style.display='none';
    }
});

// --- CARGAR REFERENCIAS DE IMAGEN ---
async function cargarReferenciasDesdeFirebase() {

    const snap = await db.ref(`${idEmpresa}/perfilempresa/urljason`).once('value');
    const urlJSON = snap.val();

    if (!urlJSON) {
        console.warn('‚ö†Ô∏è No hay urljason configurado');
        referenciasDrive = {};
        return;
    }

    try {
        const resp = await fetch(urlJSON);
        referenciasDrive = await resp.json() || {};
        console.log('‚úÖ JSON Drive cargado', referenciasDrive);
    } catch (e) {
        console.error('‚ùå Error cargando JSON Drive', e);
        referenciasDrive = {};
    }
}

// --- AUTO ASIGNAR IMAGEN DESDE REFERENCIA ---

async function validarYAsignarImagenDesdeReferencia(idDomi, idPedido, pedido) {

    // 1Ô∏è‚É£ Si ya tiene imagen en cualquier propiedad ‚Üí no tocar
    if ((pedido.imagenUrl && pedido.imagenUrl.trim() !== '') || (pedido.imagen && pedido.imagen.trim() !== '')) {
        return false; // nada cambi√≥
    }

    // 2Ô∏è‚É£ Si no hay referencia ‚Üí no hacer nada
    if (!pedido.referencia) return false;

    const urlImagen = referenciasDrive[pedido.referencia];
    if (!urlImagen) return false;

    // 3Ô∏è‚É£ Solo actualizar si realmente no tiene imagen en Firebase
    try {
        const snapshot = await db.ref(`${idEmpresa}/Pedidos/${idDomi}/${idPedido}/imagenUrl`).get();
        if (snapshot.exists() && snapshot.val().trim() !== '') {
            // Ya tiene imagen en Firebase, solo asignamos en memoria
            pedido.imagenUrl = snapshot.val();
            return false;
        }

        // 4Ô∏è‚É£ Asignar directamente en memoria
        pedido.imagenUrl = urlImagen;

        // 5Ô∏è‚É£ Actualizar Firebase
        await db
            .ref(`${idEmpresa}/Pedidos/${idDomi}/${idPedido}`)
            .update({
                imagenUrl: urlImagen,
                imagenAuto: true
            });

        console.log(`üñºÔ∏è Imagen asignada autom√°ticamente ‚Üí ${pedido.referencia}`);
        return true; // hubo cambio

    } catch (e) {
        console.error('‚ùå Error asignando imagen', e);
        return false;
    }
}


// --- OBTENER IMAGEN PARA MOSTRAR ---
function obtenerImagenPedido(p){
    let url = '';

    // 1Ô∏è‚É£ Usar imagen existente en el pedido
    if(p.imagenUrl && p.imagenUrl.trim() !== ''){
        url = p.imagenUrl;
    } 
    // 2Ô∏è‚É£ Si no hay, usar la referencia del JSON
    else if(p.referencia && referenciasDrive[p.referencia]){
        url = referenciasDrive[p.referencia];
    }

    // 3Ô∏è‚É£ Normalizar URLs de Drive
    if(url.includes('drive.google.com')){
        const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if(match && match[1]){
            // URL directa para web/Android
            return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w1000`;
        }
    }

    // 4Ô∏è‚É£ Si no es Drive, devolver tal cual
    return url;
}

// --- CARGAR PEDIDOS ---
function cargarPedidosRealtime() {

    const grid = document.getElementById("pedidosGrid");
    if (!grid) return;

    const pedidosRef = db.ref(`${idEmpresa}/Pedidos`);
    const domiRef = db.ref(`${idEmpresa}/Domiciliarios`);

    domiRef.once('value').then(domiSnap => {

        const domiciliarios = {};
        domiSnap.forEach(d => {
            domiciliarios[d.key] = {
                nombre: d.child('nombre').val() || '',
                telefono: d.child('telefono').val() || ''
            };
        });

        // üî• ESCUCHA REALTIME
        pedidosRef.on('value', snapshot => {

            grid.innerHTML = '';
            const pedidosPorFecha = {};

            snapshot.forEach(domicSnap => {

                const idDomi = domicSnap.key;

                domicSnap.forEach(pedidoSnap => {

                    const p = pedidoSnap.val();
                    if (!p || !p.diaEntrega) return;

                    const idPedido = pedidoSnap.key;

                    // ‚úÖ AUTO ASIGNAR IMAGEN (SOLO SI EST√Å VAC√çA)
                    validarYAsignarImagenDesdeReferencia(
                        idDomi,
                        idPedido,
                        p
                    );

                    // --- AGRUPAR POR FECHA ---
                    if (!pedidosPorFecha[p.diaEntrega]) {
                        pedidosPorFecha[p.diaEntrega] = [];
                    }

                    pedidosPorFecha[p.diaEntrega].push({
                        pedido: p,
                        idPedido,
                        idDomiActual: idDomi
                    });
                });
            });

            // --- PINTAR EN ORDEN ---
            Object.keys(pedidosPorFecha)
                .sort((a, b) => convertirFecha(a) - convertirFecha(b))
                .forEach(fecha => {

                    const header = document.createElement('div');
                    header.className = 'fecha-header';
                    header.textContent = formatearFechaBonita(fecha);
                    grid.appendChild(header);

                    pedidosPorFecha[fecha].forEach(item => {

                        const domiActual = domiciliarios[item.idDomiActual] || {};

                        const card = crearPedidoCard(
                            item.idPedido,
                            item.idDomiActual,
                            item.pedido,
                            domiActual,
                            domiciliarios
                        );

                        grid.appendChild(card);
                    });
                });
        });
    });
}
function normalizarImagen(url){
    if(!url) return '';
    return url; // nada m√°s
}

function crearPedidoCard(idPedido, idDomiActual, p, domiActual, domiciliarios) {

    const card = document.createElement('div');
    card.className = 'pedido-card';
    card.style.backgroundColor = obtenerColorPedido(p.color);

    card.innerHTML = `
        <div class="pedido-top">
            <img class="pedido-img"
                 src="${obtenerImagenPedido(p)}"
                 loading="lazy">

            <div class="pedido-info">

                <div class="linea ref">üè∑Ô∏è ${p.referencia || 'Pedido'}</div>

                <div class="linea">
                    üë§ ${p.nombreCliente || ''}
                    <div class="sub-linea">
                        #Ô∏è‚É£N¬∞:
                        <a class="whatsapp-link"
                           href="https://wa.me/${(p.cliente || '').replace(/\D/g, '')}"
                           target="_blank">
                           ${p.cliente || ''}
                        </a>
                    </div>
                </div>

                <div class="linea">
                    üéÅ ${p.nombreDestinatario || ''}
                    <div class="sub-linea">üìû ${p.destinatario || ''}</div>
                </div>

                <div class="linea">
                    üìç 
                    <a class="maps-link"
                       href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.direccion || '')}"
                       target="_blank">
                        ${p.direccion || ''}
                    </a>
                </div>

                <div class="linea">
                    üìÖ ${p.diaEntrega || ''}
                    <div class="sub-linea">‚è∞ ${p.horaEntrega || ''}</div>
                </div>

            </div>
        </div>

        <div class="pedido-bottom">
             <div class="linea"><strong>üè†:</strong> ${p.notas || ''}</div>

          <div class="linea mensaje-linea">
            <strong>üìù:</strong>
            <span class="mensaje-texto">${p.mensaje || ''}</span>
            <button class="btn-editar-mensaje">‚úèÔ∏è</button>
            <button class="btn-imprimir">üñ® Imprimir</button>
            <label class="switch-ruta">
                <input type="checkbox" class="chkRuta">
                üöòEn Ruta
            </label>
            <div class="etiqueta-ruta">
                <span>EN</span>
                <span>RUTA</span>
            </div>
          </div>

            <div class="linea">
                üëâ De: ${p.de || ''} üëâ Para: ${p.para || ''}
            </div>

            <div class="linea domiciliario-linea">
                üöó 
                <select class="domi-select"></select>
                <span class="domi-telefono">üìû ${domiActual.telefono || ''}</span>
            </div>

            <div class="linea">
                üïí ${p.fechaRegistro || ''} ¬∑ ${p.horaRegistro || ''}
            </div>
        </div>
    `;

    /* ====== IMPRIMIR TARJETA ====== */
    const btnImprimir = card.querySelector('.btn-imprimir');
    if (btnImprimir) {
        btnImprimir.onclick = () => {
            abrirImpresion({
                mensaje: p.mensaje || '',
                para: p.para || '',
                de: p.de || ''
            });
        };
    }

    /* ====== SPINNER DOMICILIARIOS ====== */
    const select = card.querySelector('.domi-select');
    const telSpan = card.querySelector('.domi-telefono');

    Object.entries(domiciliarios).forEach(([id, d]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = d.nombre;
        if (id === idDomiActual) option.selected = true;
        select.appendChild(option);
    });

    /* ====== CAMBIO DOMICILIARIO ====== */
    select.addEventListener('change', async () => {
        const idDomiNuevo = select.value;
        if (idDomiNuevo === idDomiActual) return;

        try {
            await moverPedidoDomiciliario(idPedido, idDomiActual, idDomiNuevo, p);
            telSpan.textContent = `üìû ${domiciliarios[idDomiNuevo]?.telefono || ''}`;
            idDomiActual = idDomiNuevo;
        } catch (e) {
            alert('Error al cambiar domiciliario');
            select.value = idDomiActual;
        }
    });

    /* ====== EN RUTA (EFECTO VISUAL PERSISTENTE) ====== */
    const chkRuta = card.querySelector('.chkRuta');
    const rutas = JSON.parse(localStorage.getItem('pedidosEnRuta')) || {};

    if (rutas[idPedido]) {
        chkRuta.checked = true;
        card.classList.add('en-ruta');
    }

    chkRuta.addEventListener('change', () => {
        const rutasActuales = JSON.parse(localStorage.getItem('pedidosEnRuta')) || {};
        if (chkRuta.checked) {
            rutasActuales[idPedido] = true;
            card.classList.add('en-ruta');
        } else {
            delete rutasActuales[idPedido];
            card.classList.remove('en-ruta');
        }
        localStorage.setItem('pedidosEnRuta', JSON.stringify(rutasActuales));
    });

    /* ====== EDITAR MENSAJE ====== */
    function activarEdicionMensaje() {
        const btnEditar = card.querySelector('.btn-editar-mensaje');
        const mensajeSpan = card.querySelector('.mensaje-texto');
        if (!btnEditar || !mensajeSpan) return;

        btnEditar.onclick = () => {
            const textoOriginal = mensajeSpan.textContent;

            const textarea = document.createElement('textarea');
            textarea.value = textoOriginal;
            textarea.style.width = '100%';
            textarea.rows = 3;

            const btnGuardar = document.createElement('button');
            btnGuardar.textContent = 'üíæ Guardar';
            btnGuardar.style.marginRight = '6px';

            const btnCancelar = document.createElement('button');
            btnCancelar.textContent = '‚ùå Cancelar';

            const contenedorBtns = document.createElement('div');
            contenedorBtns.style.marginTop = '5px';
            contenedorBtns.append(btnGuardar, btnCancelar);

            mensajeSpan.replaceWith(textarea);
            btnEditar.replaceWith(contenedorBtns);

            /* ====== GUARDAR ====== */
            btnGuardar.onclick = async () => {
                const nuevoMensaje = textarea.value.trim();
                try {
                    await db.ref(`${idEmpresa}/Pedidos/${idDomiActual}/${idPedido}`)
                        .update({ mensaje: nuevoMensaje });

                    const nuevoSpan = document.createElement('span');
                    nuevoSpan.className = 'mensaje-texto';
                    nuevoSpan.textContent = nuevoMensaje;

                    const nuevoBtnEditar = document.createElement('button');
                    nuevoBtnEditar.className = 'btn-editar-mensaje';
                    nuevoBtnEditar.textContent = '‚úèÔ∏è';

                    textarea.replaceWith(nuevoSpan);
                    contenedorBtns.replaceWith(nuevoBtnEditar);

                    activarEdicionMensaje(); // reactivar
                } catch (e) {
                    alert('Error guardando mensaje');
                }
            };

            /* ====== CANCELAR ====== */
            btnCancelar.onclick = () => {
                const spanOriginal = document.createElement('span');
                spanOriginal.className = 'mensaje-texto';
                spanOriginal.textContent = textoOriginal;

                const nuevoBtnEditar = document.createElement('button');
                nuevoBtnEditar.className = 'btn-editar-mensaje';
                nuevoBtnEditar.textContent = '‚úèÔ∏è';

                textarea.replaceWith(spanOriginal);
                contenedorBtns.replaceWith(nuevoBtnEditar);

                activarEdicionMensaje(); // reactivar
            };
        };
    }
    activarEdicionMensaje();

    /* ====== EDITAR REFERENCIA ====== */
    function activarEdicionReferencia() {
        const lineaRef = card.querySelector('.linea.ref');
        if (!lineaRef) return;

        let btnEditarRef = lineaRef.querySelector('.btn-editar-ref');
        if (!btnEditarRef) {
            btnEditarRef = document.createElement('button');
            btnEditarRef.className = 'btn-editar-ref';
            btnEditarRef.textContent = '‚úèÔ∏è';
            btnEditarRef.style.marginLeft = '6px';
            lineaRef.appendChild(btnEditarRef);
        }

        const spanRef = document.createElement('span');
        spanRef.className = 'referencia-texto';
        spanRef.textContent = p.referencia || 'Pedido';

        lineaRef.innerHTML = `üè∑Ô∏è `;
        lineaRef.appendChild(spanRef);
        lineaRef.appendChild(btnEditarRef);

        btnEditarRef.onclick = () => {
            const textoOriginal = spanRef.textContent;

            const input = document.createElement('input');
            input.type = 'text';
            input.value = textoOriginal;
            input.style.width = '70%';

            const btnGuardar = document.createElement('button');
            btnGuardar.textContent = 'üíæ Guardar';
            btnGuardar.style.marginRight = '6px';

            const btnCancelar = document.createElement('button');
            btnCancelar.textContent = '‚ùå Cancelar';

            const contenedorBtns = document.createElement('div');
            contenedorBtns.style.display = 'inline-block';
            contenedorBtns.style.marginLeft = '6px';
            contenedorBtns.append(btnGuardar, btnCancelar);

            spanRef.replaceWith(input);
            btnEditarRef.replaceWith(contenedorBtns);

            /* ====== GUARDAR ====== */
           btnGuardar.onclick = async () => {
    const nuevaRef = input.value.trim();
    const nuevaUrl = referenciasDrive[nuevaRef] || ''; // validar URL existente

    try {
        await db.ref(`${idEmpresa}/Pedidos/${idDomiActual}/${idPedido}`)
            .update({ 
                referencia: nuevaRef,
                imagenUrl: nuevaUrl // o el campo donde guardes el URL
            });

        spanRef.textContent = nuevaRef;
        lineaRef.innerHTML = `üè∑Ô∏è `;
        lineaRef.appendChild(spanRef);
        lineaRef.appendChild(btnEditarRef);

        activarEdicionReferencia(); // reactivar
    } catch (e) {
        alert('Error guardando referencia');
    }
};


            /* ====== CANCELAR ====== */
            btnCancelar.onclick = () => {
                spanRef.textContent = textoOriginal;
                lineaRef.innerHTML = `üè∑Ô∏è `;
                lineaRef.appendChild(spanRef);
                lineaRef.appendChild(btnEditarRef);

                activarEdicionReferencia(); // reactivar
            };
        };
    }
    activarEdicionReferencia();

    return card;
}

async function moverPedidoDomiciliario(idPedido, idDomiViejo, idDomiNuevo, pedido) {

    if (idDomiViejo === idDomiNuevo) return;

    const baseRef = db.ref(`${idEmpresa}/Pedidos`);
    const refViejo = baseRef.child(idDomiViejo).child(idPedido);
    const refNuevo = baseRef.child(idDomiNuevo);

    const snap = await refNuevo.once('value');
    let ultimaPos = 0;

    snap.forEach(s => {
        const pos = s.child('posicion').val() || 0;
        if (pos > ultimaPos) ultimaPos = pos;
    });

    pedido.idDomiciliario = idDomiNuevo;
    pedido.posicion = ultimaPos + 1;
    pedido.notificado = false;

    await refNuevo.child(idPedido).set(pedido);
    await refViejo.remove();
}

function obtenerColorPedido(color) {
    if (!color) return '#ffffff';

    // Asegura que sea un color HEX v√°lido
    if (color.startsWith('#') && (color.length === 7 || color.length === 4)) {
        return color;
    }

    return '#ffffff';
}
function convertirFecha(fecha) {
    const [d, m, y] = fecha.split('-');
    return new Date(y, m - 1, d);
}

function formatearFechaBonita(fecha) {

    const perfil = window.perfilEmpresa;
    if (!perfil || !perfil.nombreEmpresa) {
        return `Pedidos para entrega`;
    }

    const [d, m, y] = fecha.split('-');
    const date = new Date(y, m - 1, d);

    const fechaTexto = date.toLocaleDateString('es-CO', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });

    const nombreEmpresa = perfil.nombreEmpresa.trim();

    return `Pedidos para entrega: ${fechaTexto} ¬∑ ${nombreEmpresa}`;
}



function formatearFechaBD(fechaHora) {
    if (!fechaHora) return '';

    let date;

    // YYYY-MM-DD HH:mm
    if (typeof fechaHora === 'string' && fechaHora.includes(' ')) {
        const [f, h] = fechaHora.split(' ');
        const [y, m, d] = f.split('-');
        const [hh = '00', mm = '00'] = h.split(':');
        date = new Date(y, m - 1, d, hh, mm);
    }
    // YYYY-MM-DD
    else if (typeof fechaHora === 'string' && fechaHora.includes('-')) {
        const [y, m, d] = fechaHora.split('-');
        date = new Date(y, m - 1, d);
    }
    // ISO / timestamp
    else {
        date = new Date(fechaHora);
    }

    if (isNaN(date)) return '';

    const dia = date.toLocaleDateString('es-CO', { weekday: 'long' });

    const fecha = date.toLocaleDateString('es-CO', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });

    const hora = date.toLocaleTimeString('es-CO', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
    });

    return `${dia} ${fecha}  ${hora}`;
}
function actualizarTotales(pos, neg) {
    const totalPos = document.getElementById('totalPositivo');
    const totalNeg = document.getElementById('totalNegativo');
    const totalDif = document.getElementById('totalDiferencia');

    totalPos.textContent = `$${pos.toLocaleString('es-CO')}`;
    totalNeg.textContent = `$${Math.abs(neg).toLocaleString('es-CO')}`;

    const dif = pos + neg;
    totalDif.textContent = `$${dif.toLocaleString('es-CO')}`;

    totalDif.parentElement.style.color = dif < 0 ? '#C62828' : '#2E7D32';
}

/* ===== ABRIR VISTA PREVIA ===== */
function abrirImpresion(pedido) {

    const printArea = document.getElementById('printArea');
    const modal = document.getElementById('printModal');

    if (!printArea || !modal) {
        alert('Falta printArea o printModal');
        return;
    }

    const perfil = window.perfilEmpresa;
    if (!perfil) {
        alert("Perfil de empresa no cargado a√∫n.");
        return;
    }

    const mensaje = (pedido.mensaje || '').trim();
    const para = (pedido.para || '').trim();
    const de   = (pedido.de || '').trim();

    printArea.innerHTML = `
        <div class="tarjeta-impresion">

            <div class="logo-empresa" id="logoEmpresaContainer">
                <img id="logoEmpresa" src="" alt="Logo Empresa">
                <div class="placeholder">Click para subir logo</div>
            </div>

            <div class="mensaje-principal">${mensaje}</div>

            <div class="de-para">
                <div id="lineaPara">
                    <strong>Para:</strong> <span id="txtPara"></span>
                </div>

                <div id="lineaDe">
                    <strong>De:</strong> <span id="txtDe"></span>
                </div>
            </div>

            <div class="decoracion" style="font-size:10px; text-align:center; margin-top:2mm;">
                ${(perfil.nombreEmpresa || '').trim()} ¬∑ WhatsApp: ${(perfil.WhatsApp || '').trim()} ¬∑ ${(perfil.direccion || '').trim()} ¬∑ ${(perfil.ciudad || '').trim()}
            </div>

            <div class="decoracion" style="font-size:10px; text-align:center; margin-top:1mm;">
                Vis√≠tanos en: ${(perfil.urlPagina || '').trim()}
            </div>

        </div>
    `;

    // Insertar texto Para / De
    document.getElementById('txtPara').textContent = para;
    document.getElementById('txtDe').textContent   = de;

    // Control de visibilidad seg√∫n checkbox
    const chkPara = document.getElementById('chkPara');
    const chkDe   = document.getElementById('chkDe');

    const lineaPara = document.getElementById('lineaPara');
    const lineaDe   = document.getElementById('lineaDe');

    lineaPara.style.display = (chkPara.checked && para) ? 'block' : 'none';
    lineaDe.style.display   = (chkDe.checked && de) ? 'block' : 'none';

    // Eventos para actualizar en vivo
    chkPara.onchange = () => {
        lineaPara.style.display = (chkPara.checked && para) ? 'block' : 'none';
    };

    chkDe.onchange = () => {
        lineaDe.style.display = (chkDe.checked && de) ? 'block' : 'none';
    };

    // Logo
    const logo = document.getElementById('logoEmpresa');
    if (logo) {
        logo.addEventListener('click', () => subirImagen('logoEmpresa'));
    }

    cargarLogo();
    observarLogo();

    modal.style.display = 'flex';

    ajustarTextoMensaje();
}


/* ===== IMPRIMIR TARJETA ===== */
function imprimirTarjeta() {

ajustarTextoMensaje();

    // Obtiene el contenido de la tarjeta
    const contenido = document.getElementById('printArea').outerHTML;

    // Obtiene todos los estilos de la p√°gina para conservar formatos
    const estilos = Array.from(document.querySelectorAll('link[rel="stylesheet"], style'))
                         .map(node => node.outerHTML)
                         .join('\n');

    // Abre ventana nueva para impresi√≥n
    const ventana = window.open('', '', 'width=1000,height=600');

    ventana.document.write(`
        <html>
        <head>
            <title>Imprimir Tarjeta</title>
            ${estilos} <!-- Incluye los estilos de la p√°gina -->
            <style>
                @media print {
                    body * {
                        visibility: hidden; /* oculta todo */
                    }

                    #printArea, #printArea * {
                        visibility: visible; /* solo mostrar tarjeta */
                    }

                    #printArea {
                        position: fixed;       /* evita repetici√≥n */
                        top: 0;
                        left: 0;
                        width: 152.4mm;        /* 6 pulgadas */
                        height: 101.6mm;       /* 4 pulgadas */
                        margin: 0;
                        box-sizing: border-box;
                        page-break-inside: avoid;
                        page-break-after: always;
                        border: none;      
                        box-shadow: none; 
                    }

                    .tarjeta-impresion {
                        width: 152.4mm;
                        height: 101.6mm;
                        box-sizing: border-box;
                        position: relative; /* conserva la posici√≥n interna */
                    }
                }
            </style>
        </head>
        <body>
            ${contenido}
        </body>
        </html>
    `);

    ventana.document.close();
    ventana.focus();
    ventana.print();
    ventana.close();
}


/* ===== CERRAR MODAL ===== */
function cerrarPrint() {
    const modal = document.getElementById('printModal');
    if (modal) modal.style.display = 'none';
}

function ajustarTextoMensaje() {
    const tarjetas = document.querySelectorAll('.tarjeta-impresion');

    tarjetas.forEach(tarjeta => {
        const mensaje = tarjeta.querySelector('.mensaje-principal');
        if (!mensaje) return;

        let fontSize = 50; // tama√±o inicial grande
        const minFont = 4; // m√≠nimo
        const contenedorHeight = mensaje.clientHeight;

        mensaje.style.fontSize = fontSize + 'px';

        // Reducir hasta que el texto quepa
        while (mensaje.scrollHeight > contenedorHeight && fontSize > minFont) {
            fontSize -= 1;
            mensaje.style.fontSize = fontSize + 'px';
        }
    });
}

// Ejecutar al cargar la p√°gina o abrir modal
window.addEventListener('load', ajustarTextoMensaje);

// Guardar logo en localStorage
function guardarLogo() {
    const logo = document.getElementById('logoEmpresa');
    if (logo && logo.src) {
        localStorage.setItem('logoGuardado', logo.src);
    }
}

// Cargar logo desde localStorage
function cargarLogo() {
    const logoSrc = localStorage.getItem('logoGuardado');
    if (!logoSrc) return;

    const logo = document.getElementById('logoEmpresa');
    if (!logo) return;

    logo.src = logoSrc;

    const placeholder = document.querySelector('.logo-empresa .placeholder');
    if (placeholder) placeholder.style.display = 'none';
}

// Observar cambios autom√°ticos del logo (guardado autom√°tico)
function observarLogo() {
    const logo = document.getElementById('logoEmpresa');
    if (!logo) return;

    const observer = new MutationObserver(() => {
        guardarLogo();
    });

    observer.observe(logo, {
        attributes: true,
        attributeFilter: ['src']
    });
}

// Funci√≥n para subir imagen del logo (NO guarda manualmente)
function subirImagen(idImagen) {
    const img = document.getElementById(idImagen);
    if (!img) return;

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';

    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
            img.src = reader.result; // ‚Üê el observer se encarga de guardar
        };
        reader.readAsDataURL(file);
    };

    input.click();
}

// Cargar logo al iniciar la p√°gina
window.addEventListener('load', cargarLogo);


</script>
<iframe id="printFrame" style="display:none;"></iframe>

</body>
</html>