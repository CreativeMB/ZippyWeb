<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Zippy Contabilidad - Bases de Datos</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
    body { font-family: 'Roboto', sans-serif; margin: 0; height: 100vh; display: flex; background: linear-gradient(to bottom, #FFA000, #FFCA28); }
    #sidebar { width: 25%; background: #f9f9f9; padding: 15px; overflow-y: auto; box-sizing: border-box; border-right: 2px solid #ddd; }
    #sidebar h3 { margin-top: 0; }
    #sidebar ul { list-style: none; padding: 0; margin: 15px 0; }
    #sidebar li { padding: 10px; background: #fff; margin-bottom: 8px; cursor: pointer; border-radius: 6px; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    #sidebar li:hover { background: #eee; }
    #sidebar button { margin: 5px 0; padding: 10px; width: 100%; border-radius: 6px; border: none; cursor: pointer; font-size: 16px; }

    #main { width: 75%; padding: 15px; overflow-y: auto; box-sizing: border-box; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; font-size: 16px; }
    th { background: #eee; }

    /* Formulario estilo card */
    #formNuevoDato {
        display: none;
        margin: 15px 0;
        padding: 20px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }

    #formNuevoDato input,
    #formNuevoDato textarea {
        width: 100%;
        margin-bottom: 15px;
        padding: 18px 15px;
        font-size: 18px;
        border: 2px solid #ccc;
        border-radius: 10px;
        box-sizing: border-box;
        transition: all 0.3s ease;
    }

    #formNuevoDato input:focus,
    #formNuevoDato textarea:focus {
        border-color: #4a90e2;
        box-shadow: 0 0 10px rgba(74,144,226,0.5);
        outline: none;
        background-color: #f0f8ff;
    }

    #formNuevoDato textarea { min-height: 80px; resize: vertical; }

    #btnMasOpciones {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
        border: none;
        background-color: #FFC107;
        color: #333;
        font-size: 16px;
        cursor: pointer;
        transition: 0.2s;
    }
    #btnMasOpciones:hover { background-color: #FFB300; }

    #opcionesExtra { display: none; margin-bottom: 15px; }

    #opcionesExtra label { display: flex; align-items: center; gap: 8px; font-size: 16px; margin-bottom: 10px; }
    #opcionesExtra input[type="checkbox"] { transform: scale(1.3); cursor: pointer; }

    /* Botones grandes */
    #formNuevoDato .botones {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }
    #formNuevoDato button.guardar,
    #formNuevoDato button.cancelar {
        flex: 1;
        padding: 15px;
        font-size: 18px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        transition: 0.2s;
    }
    #formNuevoDato button.guardar { background-color: #4CAF50; color: #fff; }
    #formNuevoDato button.guardar:hover { background-color: #45a049; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    #formNuevoDato button.cancelar { background-color: #f44336; color: #fff; }
    #formNuevoDato button.cancelar:hover { background-color: #e53935; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
</style>
</head>
<body>

<div id="sidebar">
    <h3 id="sidebarTitulo">üìÇ Bases de Datos</h3>
    <button id="btnVolver" style="display:none;">‚¨ÖÔ∏è Volver</button>
    <button id="btnAgregarDato" style="display:none;">‚ûï Nuevo Dato</button>

    <div id="formNuevoDato">
        <input type="text" id="inputNombre" placeholder="üìù Nombre del √≠tem">
        <input type="number" id="inputValor" placeholder="üí∞ Valor">
        <button type="button" id="btnMasOpciones">‚öôÔ∏è M√°s opciones</button>
        <div id="opcionesExtra">
            <label><input type="checkbox" id="inputNegativo"> Negativo</label>
            <textarea id="inputNota" placeholder="üóíÔ∏è Nota o descripci√≥n"></textarea>
        </div>
        <div class="botones">
            <button id="btnGuardarDato" class="guardar">Guardar</button>
            <button id="btnCancelarDato" class="cancelar">Cancelar</button>
        </div>
    </div>

    <ul id="sidebarList"></ul>
</div>

<div id="main">
    <h3>üìù Pedidos</h3>
    <button id="btnCerrarSesion" style="margin-bottom:10px; padding:12px 15px; font-size:16px;">üö™ Cerrar Sesi√≥n</button>
    <table id="tablaPedidos">
        <thead>
            <tr>
                <th>Domiciliario</th>
                <th>ID Pedido</th>
                <th>Nombre</th>
                <th>Nota</th>
                <th>Valor</th>
                <th>Fecha Entrega</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBTphfyjQbU1AKt6sYFepJ8Q8mGp3sbtOA",
        authDomain: "zippy-727d5.firebaseapp.com",
        databaseURL: "https://zippy-727d5-default-rtdb.firebaseio.com",
        projectId: "zippy-727d5"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let idEmpresa = null;
    let baseSeleccionada = null;

    const sidebarList = document.getElementById("sidebarList");
    const sidebarTitulo = document.getElementById("sidebarTitulo");
    const btnVolver = document.getElementById("btnVolver");
    const btnAgregarDato = document.getElementById("btnAgregarDato");
    const formNuevoDato = document.getElementById("formNuevoDato");
    const inputNombre = document.getElementById("inputNombre");
    const inputValor = document.getElementById("inputValor");
    const inputNegativo = document.getElementById("inputNegativo");
    const inputNota = document.getElementById("inputNota");
    const btnGuardarDato = document.getElementById("btnGuardarDato");
    const btnCancelarDato = document.getElementById("btnCancelarDato");
    const btnCerrarSesion = document.getElementById("btnCerrarSesion");
    const btnMasOpciones = document.getElementById("btnMasOpciones");
    const opcionesExtra = document.getElementById("opcionesExtra");

    btnMasOpciones.onclick = () => {
        opcionesExtra.style.display = opcionesExtra.style.display === "none" ? "block" : "none";
    };

  // --- CERRAR SESI√ìN ---
btnCerrarSesion.onclick = () => {
    const seguro = confirm("¬øEst√° seguro que desea cerrar sesi√≥n?");
    if(!seguro) return;

    auth.signOut()
        .then(() => {
            // Opcional: redirigir al login
            window.location.href = "login.html";
        })
        .catch(err => alert("Error cerrando sesi√≥n: " + err.message));
};

// --- AUTH ---
auth.onAuthStateChanged(user => {
    if(!user){
        // Solo redirigir si no hay usuario
        window.location.href = "login.html";
    } else {
        idEmpresa = user.uid;
        cargarBases();
        cargarPedidos();
    }
});

function cargarBases() {
    sidebarTitulo.textContent = "üìÇ Bases de Datos";
    btnVolver.style.display = "none";
    btnAgregarDato.style.display = "none";
    formNuevoDato.style.display = "none";
    opcionesExtra.style.display = "none";

    const ref = db.ref(`${idEmpresa}/basededatos`);
    sidebarList.innerHTML = '';

    ref.on('child_added', baseSnap => {
        if(!baseSnap.key) return;
        const li = document.createElement('li');
        li.textContent = baseSnap.key;
        li.onclick = () => mostrarDatos(baseSnap.key);
        // Insertar al inicio para mostrar la m√°s reciente primero
        sidebarList.insertBefore(li, sidebarList.firstChild);
    });
}


    function mostrarDatos(base) {
    baseSeleccionada = base;
    sidebarTitulo.textContent = `üìÑ Datos de: ${base}`;
    btnVolver.style.display = "inline-block";
    btnAgregarDato.style.display = "inline-block";
    formNuevoDato.style.display = "none";
    opcionesExtra.style.display = "none";

    const ref = db.ref(`${idEmpresa}/basededatos/${base}`);
    ref.off();
    sidebarList.innerHTML = '';

    // Mostrar datos actuales
    ref.once('value', snapshot => {
        const itemsArray = [];
        snapshot.forEach(itemSnap => {
            const item = itemSnap.val();
            if(item && item.nombre) itemsArray.push({...item, key: itemSnap.key});
        });
        itemsArray.sort((a,b) => new Date(b.fechaHora) - new Date(a.fechaHora));
        itemsArray.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.nombre} - ${item.valor} (${item.fechaHora})`;
            sidebarList.appendChild(li);
        });
    });

    // Escuchar nuevos datos en tiempo real
    ref.on('child_added', itemSnap => {
        const item = itemSnap.val();
        if(!item || !item.nombre) return;
        const existe = Array.from(sidebarList.children).some(li => li.textContent.startsWith(item.nombre));
        if(!existe){
            const li = document.createElement('li');
            li.textContent = `${item.nombre} - ${item.valor} (${item.fechaHora})`;
            sidebarList.insertBefore(li, sidebarList.firstChild);
        }
    });
}


    btnVolver.onclick = () => cargarBases();

    btnAgregarDato.onclick = () => { if(baseSeleccionada) formNuevoDato.style.display = "block"; };
    btnCancelarDato.onclick = () => {
        formNuevoDato.style.display = "none";
        opcionesExtra.style.display = "none";
        inputNombre.value = "";
        inputValor.value = "";
        inputNegativo.checked = false;
        inputNota.value = "";
    };

    // Asignar tecla para abrir formulario (ej: F2)
document.addEventListener('keydown', (e) => {
    if(e.key === "NumpadAdd") { // cambia "+" por la tecla que quieras
        if(!baseSeleccionada) return;
        formNuevoDato.style.display = "block";
        inputNombre.focus();
        e.preventDefault();
    }
});

// Mover entre campos con Enter y guardar
[inputNombre, inputValor, inputNota].forEach((input, index, arr) => {
    input.addEventListener('keydown', (e) => {
        if(e.key === "Enter") {
            e.preventDefault();
            // Si hay m√°s campos, ir al siguiente
            if(index < arr.length - 1) {
                arr[index + 1].focus();
            } else {
                // √öltimo campo, guardar dato
                guardarDato();
            }
        }
    });
});

// Funci√≥n que guarda el dato
function guardarDato() {
    const nombre = inputNombre.value.trim();
    let valor = parseFloat(inputValor.value);
    const negativo = inputNegativo.checked;
    const nota = inputNota.value.trim();

    if(!nombre || isNaN(valor)){
        alert("Nombre y valor son requeridos");
        return;
    }

    if(negativo) valor = -Math.abs(valor);

    const ref = db.ref(`${idEmpresa}/basededatos/${baseSeleccionada}`);
    const newKey = ref.push().key;

    const ahora = new Date();
    const fechaHora = `${ahora.getFullYear()}-${String(ahora.getMonth()+1).padStart(2,'0')}-${String(ahora.getDate()).padStart(2,'0')} ${String(ahora.getHours()).padStart(2,'0')}:${String(ahora.getMinutes()).padStart(2,'0')}`;

    ref.child(newKey).set({
        id: newKey,
        fechaHora: fechaHora,
        nombre: nombre,
        valor: valor,
        nota: nota || ""
    });

    // Limpiar formulario y dejar foco en nombre para nuevo dato r√°pido
    inputNombre.value = "";
    inputValor.value = "";
    inputNegativo.checked = false;
    inputNota.value = "";
    inputNombre.focus();
}


    function cargarPedidos() {
        const ref = db.ref(`${idEmpresa}/Pedidos`);
        const tbody = document.querySelector("#tablaPedidos tbody");
        ref.on('value', snapshot => {
            tbody.innerHTML = '';
            snapshot.forEach(domicSnap => {
                const idDomic = domicSnap.key;
                domicSnap.forEach(pedidoSnap => {
                    const p = pedidoSnap.val();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${idDomic}</td>
                        <td>${pedidoSnap.key}</td>
                        <td>${p.nombre || ''}</td>
                        <td>${p.nota || ''}</td>
                        <td>${p.valor || ''}</td>
                        <td>${p.diaEntrega || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        });
    }
</script>

</body>
</html>
