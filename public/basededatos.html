<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ZippyWeb</title>
 <link rel="icon" href="favicon.ico" type="image/x-icon">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
    body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    min-height: 100vh;
    display: flex;

    background: linear-gradient(
        to bottom,
        rgba(74, 173, 78, 0.34),
        rgba(0, 150, 136, 0.90)
    );
}

    /* Barra lateral a la derecha con fondo negro */
#sidebar {
    width: 25%;
    background: #000; /* fondo negro */
    color: #fff; /* texto blanco */
    padding: 15px;
    overflow-y: auto;
    box-sizing: border-box;
    border-left: 2px solid #444; /* en lugar de border-right */
    border-right: none;
    position: fixed; /* fijar al lado derecho */
    top: 0;
    right: 0; /* mover al lado derecho */
    height: 100vh;
}

/* Cambiar estilos de lista dentro de la sidebar */
#sidebar li {
    padding: 10px;
    background: #111; /* ligeramente m√°s claro que el negro */
    margin-bottom: 8px;
    cursor: pointer;
    border-radius: 6px;
    transition: 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

#sidebar li:hover {
    background: #222;
}

/* Botones dentro de la barra */
#sidebar button {
    margin: 5px 0;
    padding: 10px;
    width: 100%;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 16px;
    background: #333;
    color: #fff;
    transition: 0.2s;
}

#sidebar button:hover {
    background: #555;
}

/* Ajustar el main para que no quede tapado */
#main {
    margin-right: 25%; /* dejar espacio para la sidebar */
    padding: 15px;
}

   /* Tabla */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
th, td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: left;
    font-size: 16px;
}
th {
    background: #eee;
}

/* Formulario estilo card */
#formNuevoDato {
    display: none; /* Oculto hasta abrir */
    margin: 15px 0;
    padding: 20px;
    background: #1c1c1c; /* Fondo oscuro para resaltar inputs */
    border-radius: 12px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
    position: relative;
    color: #fff; /* Texto claro sobre fondo oscuro */
}

/* Inputs y textarea */
#formNuevoDato input,
#formNuevoDato textarea {
    width: 100%;
    margin-bottom: 15px;
    padding: 15px;
    font-size: 16px;
    border: 2px solid #555;
    border-radius: 10px;
    box-sizing: border-box;
    transition: all 0.3s ease;
    background-color: #2c2c2c; /* Fondo oscuro input */
    color: #fff;
}

#formNuevoDato input:focus,
#formNuevoDato textarea:focus {
    border-color: #4a90e2;
    box-shadow: 0 0 10px rgba(74,144,226,0.5);
    outline: none;
    background-color: #333;
}

#formNuevoDato textarea {
    min-height: 80px;
    resize: vertical;
}

/* Bot√≥n m√°s opciones */
#btnMasOpciones {
    width: 100%;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: none;
    background-color: #FFC107;
    color: #333;
    font-size: 16px;
    cursor: pointer;
    transition: 0.2s;
}
#btnMasOpciones:hover {
    background-color: #FFB300;
}

/* Opciones extra */
#opcionesExtra {
    display: none;
    margin-bottom: 15px;
    padding: 10px;
    background-color: #2a2a2a;
    border-radius: 8px;
}

#opcionesExtra label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
    margin-bottom: 10px;
    color: #fff; /* Asegura visibilidad del texto */
}

#opcionesExtra input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
}

/* Botones de guardar/cancelar */
#formNuevoDato .botones {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

#formNuevoDato button.guardar,
#formNuevoDato button.cancelar {
    flex: 1;
    padding: 15px;
    font-size: 16px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: 0.2s;
}

#formNuevoDato button.guardar {
    background-color: #4CAF50;
    color: #fff;
}
#formNuevoDato button.guardar:hover {
    background-color: #45a049;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

#formNuevoDato button.cancelar {
    background-color: #f44336;
    color: #fff;
}
#formNuevoDato button.cancelar:hover {
    background-color: #e53935;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

    /* Sugerencias */
    #suggestions {
        position: absolute;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        max-height: 120px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    #suggestions div:hover { background: #eee; cursor: pointer; }
    /* ================= CONTENEDOR GRID ================= */
/* CONTENEDOR GRID */
#pedidosGrid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1px;
    padding: 1px 0; /* margen arriba y abajo del grid */
}

/* TARJETAS */
.pedido-card {
    border-radius: 14px;
    padding: 10px;  /* espacio interno reducido a 2px */
    display: flex;
    flex-direction: column;
    gap: 2px;      /* espacio entre elementos internos */
}

/* PARTE SUPERIOR */
.pedido-top {
    display: flex;
    gap: 2px;
    align-items: flex-start;
}

/* IMAGE */
.pedido-img {
    width: 110px;
    height: 160px;
    object-fit: contain;
    background: #fff;
    border-radius: 10px;
    flex-shrink: 0;
}

/* PARTE INFERIOR */
.pedido-bottom {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-top: 2px; /* margen entre top y bottom */
}

/* TEXTO COMPACTO */
.linea {
    font-size: 13px;
    line-height: 1.2;
    margin: 0;
    padding: 0;
}

/* BODY */
.pedido-body p,
.pedido-body h4 {
    margin: 2px 0;
}

/* TITULO */
.pedido-body h4 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
}

.pedido-info {
    font-size: 16px; /* ajusta al tama√±o que quieras */
     font-weight: bold;
}
.pedido-info .linea,
.pedido-info .sub-linea,
.pedido-info .linea.ref {
    font-size: inherit; /* hereda el tama√±o del contenedor principal */
}


/* MENSAJE LARGO */
.mensaje {
    font-size: 12.5px;
    white-space: pre-wrap;
}

/* FOOTER */
.pedido-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 1px 0; /* margen superior e inferior */
    font-size: 11px;
}

/* COLOR */
.color-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

/* RESPONSIVE */
@media (max-width: 600px) {
    .pedido-card {
        flex-direction: column;
    }

    .pedido-img {
        width: 100%;
        height: 220px;
    }
}

/* SEPARADOR DE FECHA */
.fecha-header {
    grid-column: 1 / -1;
    font-weight: 600;
    font-size: 15px;
    margin: 2px 0; /* margen arriba y abajo de 2px */
    padding: 6px 10px; /* padding reducido */
    background: #f5f5f5;
    border-radius: 8px;
}

.maps-link {
    color: #0c6eee;      /* azul Google */
    text-decoration: none;
    font-weight: normal;
}

.maps-link:hover {
    text-decoration: underline;
}

.domiciliario-linea {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
}

.domi-select {
    font-size: 14px;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #fff;
}

.domi-telefono {
    font-size: 13px;
}

.resumen-oculto {
    display: none;
}

/* === RESUMEN === */
#resumenTotales {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin: 12px 0;
}

/* tarjetas */
#resumenTotales .total {
    padding: 10px;
    border-radius: 12px;
    text-align: center;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

#resumenTotales .label {
    display: block;
    font-size: 12px;
    opacity: 0.85;
    margin-bottom: 4px;
}

/* colores */
.total.positivo { background:#E8F5E9; color:#2E7D32; }
.total.negativo { background:#FFEBEE; color:#C62828; }
.total.diferencia { background:#E3F2FD; color:#1565C0; }

/* botones */
.acciones {
    display: flex;
    gap: 8px;
}

.acciones button {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
}

/* =========================
   MODAL DE IMPRESI√ìN
========================= */
.print-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}


.print-contenido {
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    width: 420px;
    max-height: 90vh;
    overflow: auto;
}

.print-botones {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}

.print-botones button {
    padding: 8px 14px;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
}

/* =========================
   TARJETA IMPRESI√ìN BASE
========================= */
.tarjeta-impresion {
    width: 101.6mm;
    height: 152.4mm;
    padding: 10mm;
    box-sizing: border-box;

    background: #ffffff;
    border: 1.5px solid #ccc;

    font-family: 'Georgia', serif;

    display: flex;
    flex-direction: column;
}

/* =========================
   MENSAJE PRINCIPAL
========================= */
.mensaje-principal {
    flex: 1;              /* ‚úî correcto */
    font-size: 15px;
    text-align: center;
    line-height: 1.55;
    white-space: pre-wrap;
}


/* =========================
   DE / PARA
========================= */
.de-para {
    margin-top: 6mm;
    font-size: 13px;
}

.de-para div {
    margin-top: 2mm;
}

/* =========================
   DECORACI√ìN INFERIOR
========================= */
.decoracion {
    text-align: center;
    font-size: 20px;
    margin-top: 6mm;
}

.decoracion-top {
    font-size: 12px;
    font-weight: bold;
    margin-bottom: 6mm;
}


/* =========================
   VISTA PREVIA (SOLO PANTALLA)
========================= */
.print-contenido {
    width: 90vw;
    max-width: 900px;
}

.print-area-horizontal {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 10px;
}



/* Tarjeta horizontal SOLO en pantalla */
@media screen {
    .print-area-horizontal .tarjeta-impresion {
        width: 152.4mm;  /* horizontal */
        height: 101.6mm;
    }
}

/* =========================
   IMPRESI√ìN REAL
========================= */
@media print {

    body * {
        display: none !important;
    }

    #printArea,
    #printArea * {
        display: block !important;
    }

    #printArea {
        position: absolute;
        inset: 0;
    }

    .tarjeta-impresion {
        width: 101.6mm;   /* vertical real */
        height: 152.4mm;
    }

    @page {
        size: 101.6mm 152.4mm;
        margin: 0;
    }
}


</style>
</head>
<body>

<div id="sidebar">
       <button id="btnCerrarSesion" style="margin-bottom:5px; padding:8px 10px; font-size:16px;">üö™ Cerrar Sesi√≥n</button>
    <h3 id="sidebarTitulo">üìÇ Contabilidad</h3>
   <div id="resumenTotales" class="resumen-oculto">
    <div class="total positivo">
        <span class="label">Ingresos</span>
        <span id="totalPositivo">$0</span>
    </div>

    <div class="total negativo">
        <span class="label">Gastos</span>
        <span id="totalNegativo">$0</span>
    </div>

    <div class="total diferencia">
        <span class="label">Balance</span>
        <span id="totalDiferencia">$0</span>
    </div>
</div>

<div class="acciones">
    <button id="btnVolver" style="display:none;">‚¨ÖÔ∏è Volver</button>
    <button id="btnAgregarDato" style="display:none;">‚ûï Nuevo Producto</button>
</div>


    <button id="btnVolver" style="display:none;">‚¨ÖÔ∏è Volver</button>
    <button id="btnAgregarDato" style="display:none;">‚ûï Nuevo Producto</button>

    <div id="formNuevoDato">
        <input type="number" id="inputValor" placeholder="üí∞ Precio">
        <input type="text" id="inputNombre" placeholder="üìù Nombre">
        <div id="opcionesExtra">
            <label><input type="checkbox" id="inputNegativo"> Negativo</label>
            <textarea id="inputNota" placeholder="üóíÔ∏è Nota o descripci√≥n"></textarea>
        </div>
        <div class="botones">
            <button id="btnGuardarDato" class="guardar">Guardar</button>
            <button id="btnCancelarDato" class="cancelar">Cancelar</button>
            <button type="button" id="btnMasOpciones">‚öôÔ∏è M√°s opciones</button>
        </div>
    </div>

    <ul id="sidebarList"></ul>
</div>

<div id="main">
 
    <!-- ================= PEDIDOS ================= -->
<div id="pedidos-container">

    <!-- Grid responsive -->
    <div id="pedidosGrid"></div>

</div>

</div>

<div id="printModal" class="print-modal">
    <div class="print-contenido horizontal">

        <h3>üñ® Vista previa de impresi√≥n</h3>

        <div id="printArea" class="print-area-horizontal">
            <!-- Tarjeta se carga aqu√≠ -->
        </div>

        <div class="print-botones">
            <button onclick="imprimirTarjeta()">üñ® Imprimir</button>
            <button onclick="cerrarPrint()">‚ùå Cancelar</button>
        </div>

    </div>
</div>


<script>
const firebaseConfig = {
    apiKey: "AIzaSyBTphfyjQbU1AKt6sYFepJ8Q8mGp3sbtOA",
    authDomain: "zippy-727d5.firebaseapp.com",
    databaseURL: "https://zippy-727d5-default-rtdb.firebaseio.com",
    projectId: "zippy-727d5"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let idEmpresa = null;
let baseSeleccionada = null;

const sidebarList = document.getElementById("sidebarList");
const sidebarTitulo = document.getElementById("sidebarTitulo");
const btnVolver = document.getElementById("btnVolver");
const btnAgregarDato = document.getElementById("btnAgregarDato");
const formNuevoDato = document.getElementById("formNuevoDato");
const inputNombre = document.getElementById("inputNombre");
const inputValor = document.getElementById("inputValor");
const inputNegativo = document.getElementById("inputNegativo");
const inputNota = document.getElementById("inputNota");
const btnGuardarDato = document.getElementById("btnGuardarDato");
const btnCancelarDato = document.getElementById("btnCancelarDato");
const btnCerrarSesion = document.getElementById("btnCerrarSesion");
const btnMasOpciones = document.getElementById("btnMasOpciones");
const opcionesExtra = document.getElementById("opcionesExtra");

// --- M√°s opciones ---
btnMasOpciones.onclick = () => {
    opcionesExtra.style.display = opcionesExtra.style.display === "none" ? "block" : "none";
};

// --- CERRAR SESI√ìN ---
btnCerrarSesion.onclick = () => {
    if(confirm("¬øEst√° seguro que desea cerrar sesi√≥n?")){
        auth.signOut().then(()=> window.location.href="login.html")
        .catch(err => alert("Error cerrando sesi√≥n: " + err.message));
    }
};

// --- AUTH ---
auth.onAuthStateChanged(user => {
    if(!user){
        window.location.href = "login.html";
    } else {
        idEmpresa = user.uid;
        cargarPerfilEmpresa();
        cargarBases();
         cargarPedidosRealtime();
    }
});
// Funci√≥n para cargar el perfil de la empresa
function cargarPerfilEmpresa() {
    const ref = db.ref(`${idEmpresa}/perfilempresa`);
    ref.once('value').then(snapshot => {
        const perfil = snapshot.val();
        if (!perfil) return;

        window.perfilEmpresa = perfil;
        const resumenEmpresa = document.getElementById('resumenEmpresa');
        if (resumenEmpresa) {
            resumenEmpresa.textContent = `${perfil.nombreEmpresa} ¬∑ WhatsApp: ${perfil.WhatsApp}`;
        }
    }).catch(err => {
        console.error("Error cargando perfil de empresa:", err);
    });
}

// --- CARGAR BASES ---
function cargarBases() {
    document.getElementById('resumenTotales').style.display = 'none';
    sidebarTitulo.textContent = "üìÇ Contabilidad";
    btnVolver.style.display = "none";
    btnAgregarDato.style.display = "none";
    formNuevoDato.style.display = "none";
    opcionesExtra.style.display = "none";

    sidebarList.innerHTML = '';

    const ref = db
        .ref(`${idEmpresa}/basededatos`)
        .orderByChild('timestamp')
        .limitToLast(100);

    ref.on('child_added', snap => {
        if (!snap.exists()) return;

        const li = document.createElement('li');
        li.textContent = snap.key;
        li.onclick = () => mostrarDatos(snap.key);

        // üî• M√ÅS RECIENTE ARRIBA
        sidebarList.insertBefore(li, sidebarList.firstChild);
    });
}


// --- BOTONES ---
btnVolver.onclick = () => {
    document.getElementById('resumenTotales').style.display = 'none';
    cargarBases();
};


btnAgregarDato.onclick = () => {
    if(baseSeleccionada){
        formNuevoDato.style.display = "block";
        inputValor.focus();
    }
};

btnCancelarDato.onclick = () => {
    formNuevoDato.style.display = "none";
    opcionesExtra.style.display = "none";
    inputNombre.value = "";
    inputValor.value = "";
    inputNegativo.checked = false;
    inputNota.value = "";
};

// Guardar llama a la funci√≥n √∫nica que escribe en Firebase
btnGuardarDato.onclick = () => {
    guardarDato();
};


// --- TECLAS ---
document.addEventListener('keydown', e => {
    if(e.key === "F2"){ 
        if(!baseSeleccionada) return;
        formNuevoDato.style.display = "block";
        inputValor.focus();
        e.preventDefault();
    }
});

// Enter entre campos
[inputValor, inputNombre, inputNota].forEach((input,index,arr)=>{
    input.addEventListener('keydown', e=>{
        if(e.key==="Enter"){
            e.preventDefault();
            if(index < arr.length-1) arr[index+1].focus();
            else guardarDato();
        }
    });
});

// --- FUNCION MOSTRAR DATOS DE BASE ---
function mostrarDatos(base) {
    baseSeleccionada = base;

    sidebarTitulo.textContent = `üìÑ Datos de: ${base}`;
    btnVolver.style.display = "inline-block";
    btnAgregarDato.style.display = "inline-block";
    formNuevoDato.style.display = "none";
    opcionesExtra.style.display = "none";

    // üëâ MOSTRAR resumen SOLO al entrar a la base
    const resumen = document.getElementById('resumenTotales');
    resumen.style.display = 'grid';

    const ref = db.ref(`${idEmpresa}/basededatos/${base}`);
    ref.off();
    sidebarList.innerHTML = '';

    const itemsMostrados = new Set();

    // Totales
    let totalPositivo = 0;
    let totalNegativo = 0;

    /* ===================== üîµ CARGA INICIAL ===================== */
    ref.once('value', snapshot => {
        const itemsArray = [];

        snapshot.forEach(itemSnap => {
            const item = itemSnap.val();
            if (item && item.nombre) {
                itemsArray.push({ ...item, key: itemSnap.key });
            }
        });

        // Ordenar por fecha (m√°s reciente primero)
        itemsArray.sort((a, b) => new Date(b.fechaHora) - new Date(a.fechaHora));

        itemsArray.forEach(item => {
            itemsMostrados.add(item.key);

            const valor = Number(item.valor) || 0;
            if (valor > 0) totalPositivo += valor;
            if (valor < 0) totalNegativo += valor;

            const li = document.createElement('li');
            li.dataset.key = item.key;

            const fechaFormateada = formatearFechaBD(item.fechaHora);
            const valorTexto = `$${valor.toLocaleString('es-CO')}`;

            li.textContent = `${item.nombre} : ${valorTexto} ${fechaFormateada}`;

            if (valor < 0) {
                li.style.color = '#D32F2F';
                li.style.backgroundColor = '#FFCDD2';
            } else {
                li.style.color = '#388E3C';
                li.style.backgroundColor = '#C8E6C9';
            }

            li.style.padding = '10px';
            li.style.marginBottom = '5px';
            li.style.borderRadius = '6px';

            sidebarList.appendChild(li);
        });

        // üëâ actualizar resumen inicial
        actualizarTotales(totalPositivo, totalNegativo);
    });

    /* ===================== üî¥ TIEMPO REAL ===================== */
    ref.on('child_added', itemSnap => {
        if (itemsMostrados.has(itemSnap.key)) return;

        const item = itemSnap.val();
        if (!item || !item.nombre) return;

        itemsMostrados.add(itemSnap.key);

        const valor = Number(item.valor) || 0;
        if (valor > 0) totalPositivo += valor;
        if (valor < 0) totalNegativo += valor;

        const li = document.createElement('li');
        li.dataset.key = itemSnap.key;

        const fechaFormateada = formatearFechaBD(item.fechaHora);
        const valorTexto = `$${valor.toLocaleString('es-CO')}`;

        li.textContent = `${item.nombre} : ${valorTexto} ${fechaFormateada}`;

        if (valor < 0) {
            li.style.color = '#D32F2F';
            li.style.backgroundColor = '#FFCDD2';
        } else {
            li.style.color = '#388E3C';
            li.style.backgroundColor = '#C8E6C9';
        }

        li.style.padding = '10px';
        li.style.marginBottom = '5px';
        li.style.borderRadius = '6px';

        sidebarList.insertBefore(li, sidebarList.firstChild);

        // üëâ actualizar resumen en tiempo real
        actualizarTotales(totalPositivo, totalNegativo);
    });
}

// --- FUNCION GUARDAR DATO ---
function guardarDato() {
    const nombre = inputNombre.value.trim();
    let valor = parseFloat(inputValor.value);
    const negativo = inputNegativo.checked;
    const nota = inputNota.value.trim();

    if(!nombre || isNaN(valor)){ alert("Nombre y valor son requeridos"); return; }
    if(negativo) valor = -Math.abs(valor);

    const ref = db.ref(`${idEmpresa}/basededatos/${baseSeleccionada}`);
    const newKey = ref.push().key;

    const ahora = new Date();
    const fechaHora = `${ahora.getFullYear()}-${String(ahora.getMonth()+1).padStart(2,'0')}-${String(ahora.getDate()).padStart(2,'0')} ${String(ahora.getHours()).padStart(2,'0')}:${String(ahora.getMinutes()).padStart(2,'0')}`;

    ref.child(newKey).set({
        id: newKey,
        fechaHora,
        nombre,
        valor,
        nota: nota || ""
    }).then(() => {
        // Limpiar formulario
        inputNombre.value = "";
        inputValor.value = "";
        inputNegativo.checked = false;
        inputNota.value = "";
        formNuevoDato.style.display = "none";
        opcionesExtra.style.display = "none";

        // El listener de Firebase se encargar√° de agregar el item autom√°ticamente al DOM
    }).catch(err => alert("Error guardando dato: " + err.message));
}



function mostrarItemsConColores(items) {
    sidebarList.innerHTML = ''; // limpiar lista
    items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.nombre} - ${item.valor} (${item.fechaHora})`;

        // Colores seg√∫n valor
        if(item.valor < 0){
            li.style.color = '#D32F2F'; // rojo para negativos
            li.style.backgroundColor = '#FFCDD2'; // fondo rojo claro
        } else {
            li.style.color = '#388E3C'; // verde para positivos
            li.style.backgroundColor = '#C8E6C9'; // fondo verde claro
        }

        li.style.padding = '10px';
        li.style.marginBottom = '5px';
        li.style.borderRadius = '6px';

        sidebarList.appendChild(li);
    });
}



// --- AUTOCOMPLETADO Y ENTER PARA GUARDAR ---
const suggestionsContainer = document.createElement('div');
suggestionsContainer.id='suggestions';
suggestionsContainer.style.position='absolute';
suggestionsContainer.style.background='#fff';
suggestionsContainer.style.border='1px solid #ccc';
suggestionsContainer.style.borderRadius='6px';
suggestionsContainer.style.maxHeight='120px';
suggestionsContainer.style.overflowY='auto';
suggestionsContainer.style.zIndex='1000';
document.body.appendChild(suggestionsContainer);

function posicionarSugerencias(){
    const rect = inputNombre.getBoundingClientRect();
    suggestionsContainer.style.top = rect.bottom + window.scrollY + 'px';
    suggestionsContainer.style.left = rect.left + window.scrollX + 'px';
    suggestionsContainer.style.width = rect.width + 'px';
}

// --- AUTOCOMPLETADO INLINE (solo completa el input) ---
inputNombre.addEventListener('input', () => {
    const query = inputNombre.value.trim().toLowerCase();
    if(query.length < 2) return;

    const ref = db.ref(`${idEmpresa}/basededatos/${baseSeleccionada}`);
    ref.once('value', snapshot => {
        let primeraCoincidencia = null;
        snapshot.forEach(itemSnap => {
            const item = itemSnap.val();
            if(item && item.nombre && item.nombre.toLowerCase().startsWith(query) && !primeraCoincidencia){
                primeraCoincidencia = item.nombre;
            }
        });

        if(primeraCoincidencia){
            inputNombre.value = primeraCoincidencia;
            inputNombre.setSelectionRange(query.length, primeraCoincidencia.length);
        }
    });
});


// ENTER en Valor pasa a Nombre
inputValor.addEventListener('keydown', e=>{
    if(e.key === "Enter"){
        e.preventDefault();
        inputNombre.focus();
    }
});

// ENTER en Nombre selecciona la primera sugerencia o guarda el dato
inputNombre.addEventListener('keydown', e=>{
    if(e.key === "Enter"){
        e.preventDefault();
        if(suggestionsContainer.firstChild){
            inputNombre.value = suggestionsContainer.firstChild.textContent;
            suggestionsContainer.style.display='none';
        }
        guardarDato(); // Guardar inmediatamente sin tocar botones
    }
});

// Cerrar sugerencias al hacer clic fuera
document.addEventListener('click', (e)=>{
    if(!formNuevoDato.contains(e.target)){
        suggestionsContainer.style.display='none';
    }
});
// --- CARGAR PEDIDOS ---
function cargarPedidosRealtime() {

    const pedidosRef = db.ref(`${idEmpresa}/Pedidos`);
    const domiRef = db.ref(`${idEmpresa}/Domiciliarios`);
    const grid = document.getElementById("pedidosGrid");

    domiRef.once('value').then(domiSnap => {

        const domiciliarios = {};
        domiSnap.forEach(d => {
            domiciliarios[d.key] = {
                nombre: d.child('nombre').val() || '',
                telefono: d.child('telefono').val() || ''
            };
        });

        pedidosRef.on('value', snapshot => {

            grid.innerHTML = '';
            const pedidosPorFecha = {};

            snapshot.forEach(domicSnap => {
                const idDomi = domicSnap.key;

                domicSnap.forEach(pedidoSnap => {
                    const p = pedidoSnap.val();
                    if (!p || !p.diaEntrega) return;

                    if (!pedidosPorFecha[p.diaEntrega]) {
                        pedidosPorFecha[p.diaEntrega] = [];
                    }

                    pedidosPorFecha[p.diaEntrega].push({
                        pedido: p,
                        idPedido: pedidoSnap.key,
                        idDomiActual: idDomi
                    });
                });
            });

            Object.keys(pedidosPorFecha)
                .sort((a, b) => convertirFecha(a) - convertirFecha(b))
                .forEach(fecha => {

                    const header = document.createElement('div');
                    header.className = 'fecha-header';
                    header.textContent = formatearFechaBonita(fecha);
                    grid.appendChild(header);

                    pedidosPorFecha[fecha].forEach(item => {

                        const domiActual = domiciliarios[item.idDomiActual] || {};

                        const card = crearPedidoCard(
                            item.idPedido,
                            item.idDomiActual,
                            item.pedido,
                            domiActual,
                            domiciliarios
                        );

                        grid.appendChild(card);
                    });
                });
        });
    });
}


function crearPedidoCard(idPedido, idDomiActual, p, domiActual, domiciliarios) {

    const card = document.createElement('div');
    card.className = 'pedido-card';
    card.style.backgroundColor = obtenerColorPedido(p.color);

    card.innerHTML = `
        <div class="pedido-top">
            <img class="pedido-img"
                 src="${normalizarImagen(p.imagenUrl)}"
                 loading="lazy">

            <div class="pedido-info">

                <div class="linea ref">üè∑Ô∏è ${p.referencia || 'Pedido'}</div>

                <div class="linea">
                    üë§ ${p.nombreCliente || ''}
                    <div class="sub-linea">
                        #Ô∏è‚É£N¬∞:
                        <a class="whatsapp-link"
                           href="https://wa.me/${(p.cliente || '').replace(/\D/g, '')}"
                           target="_blank">
                           ${p.cliente || ''}
                        </a>
                    </div>
                </div>

                <div class="linea">
                    üéÅ ${p.nombreDestinatario || ''}
                    <div class="sub-linea">üìû ${p.destinatario || ''}</div>
                </div>

                <div class="linea">
                    üìç 
                    <a class="maps-link"
                       href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.direccion || '')}"
                       target="_blank">
                        ${p.direccion || ''}
                    </a>
                </div>

                <div class="linea">
                    üìÖ ${p.diaEntrega || ''}
                    <div class="sub-linea">‚è∞ ${p.horaEntrega || ''}</div>
                </div>

            </div>
        </div>

        <div class="pedido-bottom">
             <div class="linea"><strong>üè†:</strong> ${p.notas || ''}</div>

          <div class="linea mensaje-linea">
    <strong>üìù:</strong>
    <span class="mensaje-texto">${p.mensaje || ''}</span>
    <button class="btn-editar-mensaje">‚úèÔ∏è</button><button class="btn-imprimir">üñ® Imprimir</button>
</div>


            <div class="linea">
                üëâ De: ${p.de || ''} üëâ Para: ${p.para || ''}
            </div>

            <div class="linea domiciliario-linea">
                üöó 
                <select class="domi-select"></select>
                <span class="domi-telefono">üìû ${domiActual.telefono || ''}</span>
            </div>

            <div class="linea">
                üïí ${p.fechaRegistro || ''} ¬∑ ${p.horaRegistro || ''}
            </div>

        </div>
    `;
/* ====== IMPRIMIR TARJETA ====== */
const btnImprimir = card.querySelector('.btn-imprimir');

if (btnImprimir) {
    btnImprimir.onclick = () => {
        abrirImpresion({
            mensaje: p.mensaje || '',
            para: p.para || '',
            de: p.de || ''
        });
    };
}

    /* ====== SPINNER DOMICILIARIOS ====== */
    const select = card.querySelector('.domi-select');
    const telSpan = card.querySelector('.domi-telefono');

    Object.entries(domiciliarios).forEach(([id, d]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = d.nombre;
        if (id === idDomiActual) option.selected = true;
        select.appendChild(option);
    });

    /* ====== CAMBIO DOMICILIARIO ====== */
    select.addEventListener('change', async () => {

        const idDomiNuevo = select.value;
        if (idDomiNuevo === idDomiActual) return;

        try {
            await moverPedidoDomiciliario(
                idPedido,
                idDomiActual,
                idDomiNuevo,
                p
            );

            // actualizar tel√©fono visual
            telSpan.textContent = `üìû ${domiciliarios[idDomiNuevo]?.telefono || ''}`;

            idDomiActual = idDomiNuevo;

        } catch (e) {
            alert('Error al cambiar domiciliario');
            select.value = idDomiActual;
        }
    });
/* ====== EDITAR MENSAJE (CORREGIDO) ====== */

function activarEdicionMensaje() {

    const btnEditar = card.querySelector('.btn-editar-mensaje');
    const mensajeSpan = card.querySelector('.mensaje-texto');

    if (!btnEditar || !mensajeSpan) return;

    btnEditar.onclick = () => {

        const textoOriginal = mensajeSpan.textContent;

        const textarea = document.createElement('textarea');
        textarea.value = textoOriginal;
        textarea.style.width = '100%';
        textarea.rows = 3;

        const btnGuardar = document.createElement('button');
        btnGuardar.textContent = 'üíæ Guardar';
        btnGuardar.style.marginRight = '6px';

        const btnCancelar = document.createElement('button');
        btnCancelar.textContent = '‚ùå Cancelar';

        const contenedorBtns = document.createElement('div');
        contenedorBtns.style.marginTop = '5px';
        contenedorBtns.append(btnGuardar, btnCancelar);

        mensajeSpan.replaceWith(textarea);
        btnEditar.replaceWith(contenedorBtns);

        /* ====== GUARDAR ====== */
        btnGuardar.onclick = async () => {
            const nuevoMensaje = textarea.value.trim();

            try {
                await db.ref(`${idEmpresa}/Pedidos/${idDomiActual}/${idPedido}`)
                    .update({ mensaje: nuevoMensaje });

                const nuevoSpan = document.createElement('span');
                nuevoSpan.className = 'mensaje-texto';
                nuevoSpan.textContent = nuevoMensaje;

                const nuevoBtnEditar = document.createElement('button');
                nuevoBtnEditar.className = 'btn-editar-mensaje';
                nuevoBtnEditar.textContent = '‚úèÔ∏è';

                textarea.replaceWith(nuevoSpan);
                contenedorBtns.replaceWith(nuevoBtnEditar);

                activarEdicionMensaje(); // üîÅ REACTIVAR

            } catch (e) {
                alert('Error guardando mensaje');
            }
        };

        /* ====== CANCELAR ====== */
        btnCancelar.onclick = () => {

            const spanOriginal = document.createElement('span');
            spanOriginal.className = 'mensaje-texto';
            spanOriginal.textContent = textoOriginal;

            const nuevoBtnEditar = document.createElement('button');
            nuevoBtnEditar.className = 'btn-editar-mensaje';
            nuevoBtnEditar.textContent = '‚úèÔ∏è';

            textarea.replaceWith(spanOriginal);
            contenedorBtns.replaceWith(nuevoBtnEditar);

            activarEdicionMensaje(); // üîÅ REACTIVAR
        };
    };
}

// üöÄ activar edici√≥n al crear la tarjeta
activarEdicionMensaje();


    return card;
}


async function moverPedidoDomiciliario(idPedido, idDomiViejo, idDomiNuevo, pedido) {

    if (idDomiViejo === idDomiNuevo) return;

    const baseRef = db.ref(`${idEmpresa}/Pedidos`);
    const refViejo = baseRef.child(idDomiViejo).child(idPedido);
    const refNuevo = baseRef.child(idDomiNuevo);

    const snap = await refNuevo.once('value');
    let ultimaPos = 0;

    snap.forEach(s => {
        const pos = s.child('posicion').val() || 0;
        if (pos > ultimaPos) ultimaPos = pos;
    });

    pedido.idDomiciliario = idDomiNuevo;
    pedido.posicion = ultimaPos + 1;
    pedido.notificado = false;

    await refNuevo.child(idPedido).set(pedido);
    await refViejo.remove();
}




function normalizarImagen(url){
    if(!url) return '';

    if(url.includes('drive.google.com')){
        const match = url.match(/id=([^&]+)/);
        if(match && match[1]){
            return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w1000`;
        }
    }
    return url;
}
function obtenerColorPedido(color) {
    if (!color) return '#ffffff';

    // Asegura que sea un color HEX v√°lido
    if (color.startsWith('#') && (color.length === 7 || color.length === 4)) {
        return color;
    }

    return '#ffffff';
}
function convertirFecha(fecha) {
    const [d, m, y] = fecha.split('-');
    return new Date(y, m - 1, d);
}

function formatearFechaBonita(fecha) {
    const [d, m, y] = fecha.split('-');
    const date = new Date(y, m - 1, d);

    const fechaTexto = date.toLocaleDateString('es-CO', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });

    return `Pedidos para Entrega:  ${fechaTexto}`;
}
function formatearFechaBD(fechaHora) {
    if (!fechaHora) return '';

    let date;

    // YYYY-MM-DD HH:mm
    if (typeof fechaHora === 'string' && fechaHora.includes(' ')) {
        const [f, h] = fechaHora.split(' ');
        const [y, m, d] = f.split('-');
        const [hh = '00', mm = '00'] = h.split(':');
        date = new Date(y, m - 1, d, hh, mm);
    }
    // YYYY-MM-DD
    else if (typeof fechaHora === 'string' && fechaHora.includes('-')) {
        const [y, m, d] = fechaHora.split('-');
        date = new Date(y, m - 1, d);
    }
    // ISO / timestamp
    else {
        date = new Date(fechaHora);
    }

    if (isNaN(date)) return '';

    const dia = date.toLocaleDateString('es-CO', { weekday: 'long' });

    const fecha = date.toLocaleDateString('es-CO', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });

    const hora = date.toLocaleTimeString('es-CO', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
    });

    return `${dia} ${fecha}  ${hora}`;
}
function actualizarTotales(pos, neg) {
    const totalPos = document.getElementById('totalPositivo');
    const totalNeg = document.getElementById('totalNegativo');
    const totalDif = document.getElementById('totalDiferencia');

    totalPos.textContent = `$${pos.toLocaleString('es-CO')}`;
    totalNeg.textContent = `$${Math.abs(neg).toLocaleString('es-CO')}`;

    const dif = pos + neg;
    totalDif.textContent = `$${dif.toLocaleString('es-CO')}`;

    totalDif.parentElement.style.color = dif < 0 ? '#C62828' : '#2E7D32';
}
/* ===== ABRIR VISTA PREVIA ===== */
/* ===== ABRIR VISTA PREVIA ===== */
function abrirImpresion(pedido) {
    const printArea = document.getElementById('printArea');
    const modal = document.getElementById('printModal');

    if (!printArea || !modal) {
        alert('Falta printArea o printModal');
        return;
    }

    // Obtenemos el perfil de la empresa previamente cargado
    const perfil = window.perfilEmpresa;
    if (!perfil) {
        alert("Perfil de empresa no cargado a√∫n.");
        return;
    }

    // Construimos la tarjeta de impresi√≥n
    printArea.innerHTML = `
        <div class="tarjeta-impresion">

            <!-- Mensaje principal -->
            <div class="mensaje-principal">
                ${pedido.mensaje || ''}
            </div>

            <!-- De - Para -->
            <div class="de-para">
                <div><strong>Para:</strong> ${pedido.para || ''}</div>
                <div><strong>De:</strong> ${pedido.de || ''}</div>
            </div>

            <!-- Decoraci√≥n inferior: todos los datos de la empresa en una l√≠nea -->
            <div class="decoracion" style="font-size:10px; text-align:center; margin-top:2mm;">
                ${perfil.nombreEmpresa} ¬∑ WhatsApp: ${perfil.WhatsApp} ¬∑ ${perfil.direccion} ¬∑ ${perfil.ciudad}
            </div>

            <!-- URL de la empresa debajo de la decoraci√≥n -->
            <div class="decoracion-url" style="font-size:10px; text-align:center; margin-top:1mm;">
                Vis√≠tanos en: ${perfil.urlPagina}
            </div>

        </div>
    `;

    modal.style.display = 'flex';
}




/* ===== IMPRIMIR ===== */
function imprimirTarjeta() {

    const iframe = document.getElementById('printFrame');
    const printArea = document.getElementById('printArea');

    if (!iframe || !printArea || !printArea.innerHTML.trim()) {
        alert('No hay tarjeta para imprimir');
        return;
    }

    const doc = iframe.contentWindow.document;

    doc.open();
    doc.write(`
        <html>
        <head>
            <meta charset="utf-8">
            <style>
                ${document.querySelector('#printStyles').innerHTML}

                @page {
                    size: 101.6mm 152.4mm;
                    margin: 0;
                }

                body {
                    margin: 0;
                }
            </style>
        </head>
        <body>
            ${printArea.innerHTML}
        </body>
        </html>
    `);
    doc.close();

    iframe.contentWindow.focus();
    iframe.contentWindow.print();

    setTimeout(cerrarPrint, 500);
}


/* ===== CERRAR ===== */
function cerrarPrint() {
    document.getElementById('printModal').style.display = 'none';
}


</script>
<iframe id="printFrame" style="display:none;"></iframe>

</body>
</html>
