<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Zippy Contabilidad - Bases de Datos</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 0; height: 100vh; display: flex; }
    #sidebar { width: 20%; background: #f4f4f4; padding: 10px; overflow-y: auto; box-sizing: border-box; }
    #sidebar h3 { margin-top: 0; }
    #sidebar ul { list-style: none; padding: 0; margin: 10px 0; }
    #sidebar li { padding: 8px; background: #fff; margin-bottom: 5px; cursor: pointer; border-radius: 4px; }
    #sidebar li:hover { background: #ddd; }
    #sidebar button { margin: 2px; }
    #main { width: 80%; padding: 10px; overflow-y: auto; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #eee; }
    /* Modal */
    #modalDato { display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    #modalDato div { background:#fff; padding:20px; border-radius:8px; width:300px; }
    #modalDato input, #modalDato textarea { width:100%; margin-bottom:5px; }
</style>
</head>
<body>

<div id="sidebar">
    <h3 id="sidebarTitulo">üìÇ Bases de Datos</h3>
    <div id="sidebarBotones">
        <button id="btnVolver" style="display:none;">‚¨ÖÔ∏è Volver</button>
        <button id="btnAgregarDato" style="display:none;">‚ûï Nuevo Dato</button>
       
    </div>
    <ul id="sidebarList"></ul>
</div>

<div id="main">
    <h3>üìù Pedidos</h3>
     <button id="btnCerrarSesion" style="margin-left:5px;">üö™ Cerrar Sesi√≥n</button>
    <table id="tablaPedidos">
        <thead>
            <tr>
                <th>Domiciliario</th>
                <th>ID Pedido</th>
                <th>Nombre</th>
                <th>Nota</th>
                <th>Valor</th>
                <th>Fecha Entrega</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal para agregar dato -->
<div id="modalDato">
    <div>
        <h3>Nuevo Dato</h3>
        <label>Nombre:</label>
        <input type="text" id="inputNombre"><br>
        <label>Valor:</label>
        <input type="number" id="inputValor"><br>
        <label><input type="checkbox" id="inputNegativo"> Negativo</label><br>
        <label>Nota:</label>
        <textarea id="inputNota"></textarea><br>
        <button id="guardarDato">Guardar</button>
        <button id="cancelarDato">Cancelar</button>
    </div>
</div>

<script>
    // --- CONFIGURAR FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBTphfyjQbU1AKt6sYFepJ8Q8mGp3sbtOA",
        authDomain: "zippy-727d5.firebaseapp.com",
        databaseURL: "https://zippy-727d5-default-rtdb.firebaseio.com",
        projectId: "zippy-727d5"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let idEmpresa = null;
    let baseSeleccionada = null;

    const sidebarList = document.getElementById("sidebarList");
    const sidebarTitulo = document.getElementById("sidebarTitulo");
    const btnVolver = document.getElementById("btnVolver");
    const btnAgregarDato = document.getElementById("btnAgregarDato");
    const btnCerrarSesion = document.getElementById("btnCerrarSesion");

    // --- CERRAR SESI√ìN ---
    btnCerrarSesion.onclick = () => {
        auth.signOut().then(() => window.location.reload())
        .catch(err => alert("Error cerrando sesi√≥n: " + err.message));
    };

    // --- AUTH ---
    auth.onAuthStateChanged(user => {
        if(user){
            idEmpresa = user.uid;
            cargarBases();
            cargarPedidos();
        } else {
            alert("Debe iniciar sesi√≥n primero");
            window.location.href = "login.html";
        }
    });

    // --- CARGAR LISTA DE BASES ---
    function cargarBases() {
        sidebarTitulo.textContent = "üìÇ Bases de Datos";
        btnVolver.style.display = "none";
        btnAgregarDato.style.display = "none";

        const ref = db.ref(`${idEmpresa}/basededatos`);
        ref.on('value', snapshot => {
            sidebarList.innerHTML = '';
            const basesArray = [];
            snapshot.forEach(baseSnap => basesArray.push(baseSnap.key));
            basesArray.reverse(); // M√°s reciente primero
            basesArray.forEach(nombreBase => {
                const li = document.createElement('li');
                li.textContent = nombreBase;
                li.onclick = () => mostrarDatos(nombreBase);
                sidebarList.appendChild(li);
            });
        });
    }

    // --- MOSTRAR DATOS DE LA BASE SELECCIONADA ---
    function mostrarDatos(base) {
        baseSeleccionada = base;
        sidebarTitulo.textContent = `üìÑ Datos de: ${base}`;
        btnVolver.style.display = "inline-block";
        btnAgregarDato.style.display = "inline-block";

        const ref = db.ref(`${idEmpresa}/basededatos/${base}`);
        ref.on('value', snapshot => {
            sidebarList.innerHTML = '';
            const itemsArray = [];
            snapshot.forEach(itemSnap => itemsArray.push({...itemSnap.val(), key:itemSnap.key}));
            // Orden descendente por fechaHora
            itemsArray.sort((a,b) => new Date(b.fechaHora) - new Date(a.fechaHora));
            itemsArray.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.nombre || ''} - ${item.valor || ''}`;
                sidebarList.appendChild(li);
            });
        });
    }

    // --- VOLVER AL LISTADO DE BASES ---
    btnVolver.onclick = () => cargarBases();

    // --- MODAL AGREGAR NUEVO DATO ---
    btnAgregarDato.onclick = () => {
        if(!baseSeleccionada) return;
        document.getElementById("modalDato").style.display = "flex";
    };

    document.getElementById("cancelarDato").onclick = () => {
        document.getElementById("modalDato").style.display = "none";
    };

   document.getElementById("guardarDato").onclick = () => {
    const nombre = document.getElementById("inputNombre").value.trim();
    let valor = parseFloat(document.getElementById("inputValor").value);
    const negativo = document.getElementById("inputNegativo").checked;
    const nota = document.getElementById("inputNota").value.trim();

    if(!nombre || isNaN(valor)) {
        alert("Nombre y valor son requeridos");
        return;
    }

    if(negativo) valor = -Math.abs(valor);

    const ref = db.ref(`${idEmpresa}/basededatos/${baseSeleccionada}`);
    const newKey = ref.push().key;  // Genera id

    // Crear fechaHora en formato "YYYY-MM-DD HH:mm"
    const ahora = new Date();
    const yyyy = ahora.getFullYear();
    const mm = String(ahora.getMonth() + 1).padStart(2,'0');
    const dd = String(ahora.getDate()).padStart(2,'0');
    const hh = String(ahora.getHours()).padStart(2,'0');
    const min = String(ahora.getMinutes()).padStart(2,'0');
    const fechaHora = `${yyyy}-${mm}-${dd} ${hh}:${min}`;

    const dato = {
        id: newKey,
        fechaHora: fechaHora,
        nombre: nombre,
        valor: valor,
        nota: nota || ""
    };

    ref.child(newKey).set(dato);

    // Limpiar modal
    document.getElementById("inputNombre").value = "";
    document.getElementById("inputValor").value = "";
    document.getElementById("inputNegativo").checked = false;
    document.getElementById("inputNota").value = "";
    document.getElementById("modalDato").style.display = "none";
};


    // --- CARGAR PEDIDOS ---
    function cargarPedidos() {
        const ref = db.ref(`${idEmpresa}/Pedidos`);
        const tbody = document.querySelector("#tablaPedidos tbody");

        ref.on('value', snapshot => {
            tbody.innerHTML = '';
            snapshot.forEach(domicSnap => {
                const idDomic = domicSnap.key;
                domicSnap.forEach(pedidoSnap => {
                    const p = pedidoSnap.val();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${idDomic}</td>
                        <td>${pedidoSnap.key}</td>
                        <td>${p.nombre || ''}</td>
                        <td>${p.nota || ''}</td>
                        <td>${p.valor || ''}</td>
                        <td>${p.diaEntrega || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        });
    }
</script>
</body>
</html>

