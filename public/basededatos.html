<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Zippy Contabilidad</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
    body { font-family: 'Roboto', sans-serif; margin: 0; height: 100vh; display: flex; background: linear-gradient(to bottom, #FFA000, #FFCA28); }
    #sidebar { width: 25%; background: #f9f9f9; padding: 15px; overflow-y: auto; box-sizing: border-box; border-right: 2px solid #ddd; }
    #sidebar h3 { margin-top: 0; }
    #sidebar ul { list-style: none; padding: 0; margin: 15px 0; }
    #sidebar li { padding: 10px; background: #fff; margin-bottom: 8px; cursor: pointer; border-radius: 6px; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    #sidebar li:hover { background: #eee; }
    #sidebar button { margin: 5px 0; padding: 10px; width: 100%; border-radius: 6px; border: none; cursor: pointer; font-size: 16px; }

    #main { width: 75%; padding: 15px; overflow-y: auto; box-sizing: border-box; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; font-size: 16px; }
    th { background: #eee; }

    #formNuevoDato {
        display: none;
        margin: 15px 0;
        padding: 20px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        position: relative;
    }

    #formNuevoDato input,
    #formNuevoDato textarea {
        width: 100%;
        margin-bottom: 15px;
        padding: 18px 15px;
        font-size: 18px;
        border: 2px solid #ccc;
        border-radius: 10px;
        box-sizing: border-box;
        transition: all 0.3s ease;
    }

    #formNuevoDato input:focus,
    #formNuevoDato textarea:focus {
        border-color: #4a90e2;
        box-shadow: 0 0 10px rgba(74,144,226,0.5);
        outline: none;
        background-color: #f0f8ff;
    }

    #formNuevoDato textarea { min-height: 80px; resize: vertical; }

    #btnMasOpciones {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
        border: none;
        background-color: #FFC107;
        color: #333;
        font-size: 16px;
        cursor: pointer;
        transition: 0.2s;
    }
    #btnMasOpciones:hover { background-color: #FFB300; }

    #opcionesExtra { display: none; margin-bottom: 15px; }

    #opcionesExtra label { display: flex; align-items: center; gap: 8px; font-size: 16px; margin-bottom: 10px; }
    #opcionesExtra input[type="checkbox"] { transform: scale(1.3); cursor: pointer; }

    #formNuevoDato .botones {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }
    #formNuevoDato button.guardar,
    #formNuevoDato button.cancelar {
        flex: 1;
        padding: 15px;
        font-size: 18px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        transition: 0.2s;
    }
    #formNuevoDato button.guardar { background-color: #4CAF50; color: #fff; }
    #formNuevoDato button.guardar:hover { background-color: #45a049; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    #formNuevoDato button.cancelar { background-color: #f44336; color: #fff; }
    #formNuevoDato button.cancelar:hover { background-color: #e53935; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

    /* Sugerencias */
    #suggestions {
        position: absolute;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        max-height: 120px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    #suggestions div:hover { background: #eee; cursor: pointer; }
</style>
</head>
<body>

<div id="sidebar">
    <h3 id="sidebarTitulo">üìÇ Contabilidad</h3>
    <button id="btnVolver" style="display:none;">‚¨ÖÔ∏è Volver</button>
    <button id="btnAgregarDato" style="display:none;">‚ûï Nuevo Producto</button>

    <div id="formNuevoDato">
        <input type="number" id="inputValor" placeholder="üí∞ Precio">
        <input type="text" id="inputNombre" placeholder="üìù Nombre">
        <div id="opcionesExtra">
            <label><input type="checkbox" id="inputNegativo"> Negativo</label>
            <textarea id="inputNota" placeholder="üóíÔ∏è Nota o descripci√≥n"></textarea>
        </div>
        <div class="botones">
            <button id="btnGuardarDato" class="guardar">Guardar</button>
            <button id="btnCancelarDato" class="cancelar">Cancelar</button>
            <button type="button" id="btnMasOpciones">‚öôÔ∏è M√°s opciones</button>
        </div>
    </div>

    <ul id="sidebarList"></ul>
</div>

<div id="main">
    <button id="btnCerrarSesion" style="margin-bottom:10px; padding:12px 15px; font-size:16px;">üö™ Cerrar Sesi√≥n</button>
    <h3>üìù Pedidos</h3>
    <table id="tablaPedidos">
        <thead>
            <tr>
                <th>Domiciliario</th>
                <th>ID Pedido</th>
                <th>Nombre</th>
                <th>Nota</th>
                <th>Valor</th>
                <th>Fecha Entrega</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBTphfyjQbU1AKt6sYFepJ8Q8mGp3sbtOA",
    authDomain: "zippy-727d5.firebaseapp.com",
    databaseURL: "https://zippy-727d5-default-rtdb.firebaseio.com",
    projectId: "zippy-727d5"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let idEmpresa = null;
let baseSeleccionada = null;

const sidebarList = document.getElementById("sidebarList");
const sidebarTitulo = document.getElementById("sidebarTitulo");
const btnVolver = document.getElementById("btnVolver");
const btnAgregarDato = document.getElementById("btnAgregarDato");
const formNuevoDato = document.getElementById("formNuevoDato");
const inputNombre = document.getElementById("inputNombre");
const inputValor = document.getElementById("inputValor");
const inputNegativo = document.getElementById("inputNegativo");
const inputNota = document.getElementById("inputNota");
const btnGuardarDato = document.getElementById("btnGuardarDato");
const btnCancelarDato = document.getElementById("btnCancelarDato");
const btnCerrarSesion = document.getElementById("btnCerrarSesion");
const btnMasOpciones = document.getElementById("btnMasOpciones");
const opcionesExtra = document.getElementById("opcionesExtra");

// --- M√°s opciones ---
btnMasOpciones.onclick = () => {
    opcionesExtra.style.display = opcionesExtra.style.display === "none" ? "block" : "none";
};

// --- CERRAR SESI√ìN ---
btnCerrarSesion.onclick = () => {
    if(confirm("¬øEst√° seguro que desea cerrar sesi√≥n?")){
        auth.signOut().then(()=> window.location.href="login.html")
        .catch(err => alert("Error cerrando sesi√≥n: " + err.message));
    }
};

// --- AUTH ---
auth.onAuthStateChanged(user => {
    if(!user){
        window.location.href = "login.html";
    } else {
        idEmpresa = user.uid;
        cargarBases();
        cargarPedidos();
    }
});

// --- CARGAR BASES ---
function cargarBases() {
    sidebarTitulo.textContent = "üìÇ Bases de Datos";
    btnVolver.style.display = "none";
    btnAgregarDato.style.display = "none";
    formNuevoDato.style.display = "none";
    opcionesExtra.style.display = "none";

    const ref = db.ref(`${idEmpresa}/basededatos`);
    sidebarList.innerHTML = '';

    ref.on('child_added', baseSnap => {
        if(!baseSnap.key) return;
        const li = document.createElement('li');
        li.textContent = baseSnap.key;
        li.onclick = () => mostrarDatos(baseSnap.key);
        sidebarList.insertBefore(li, sidebarList.firstChild);
    });
}

// --- MOSTRAR DATOS DE BASE ---
function mostrarDatos(base) {
    baseSeleccionada = base;
    sidebarTitulo.textContent = `üìÑ Datos de: ${base}`;
    btnVolver.style.display = "inline-block";
    btnAgregarDato.style.display = "inline-block";
    formNuevoDato.style.display = "none";
    opcionesExtra.style.display = "none";

    const ref = db.ref(`${idEmpresa}/basededatos/${base}`);
    ref.off();
    sidebarList.innerHTML = '';

    // Datos actuales
    ref.once('value', snapshot => {
        const itemsArray = [];
        snapshot.forEach(itemSnap => {
            const item = itemSnap.val();
            if(item && item.nombre) itemsArray.push({...item, key: itemSnap.key});
        });
        itemsArray.sort((a,b) => new Date(b.fechaHora) - new Date(a.fechaHora));
        itemsArray.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.nombre} - ${item.valor} (${item.fechaHora})`;
            sidebarList.appendChild(li);
            // Mostrar con colores
        mostrarItemsConColores(itemsArray);
        });
    });

    // Escuchar nuevos datos en tiempo real
    ref.on('child_added', itemSnap => {
        const item = itemSnap.val();
        if(!item || !item.nombre) return;

        // Insertar al inicio
        const li = document.createElement('li');
        li.textContent = `${item.nombre} - ${item.valor} (${item.fechaHora})`;

        if(item.valor < 0){
            li.style.color = '#D32F2F';
            li.style.backgroundColor = '#FFCDD2';
        } else {
            li.style.color = '#388E3C';
            li.style.backgroundColor = '#C8E6C9';
        }

        li.style.padding = '10px';
        li.style.marginBottom = '5px';
        li.style.borderRadius = '6px';

        sidebarList.insertBefore(li, sidebarList.firstChild);
    });
}

// --- BOTONES ---
btnVolver.onclick = () => cargarBases();
btnAgregarDato.onclick = () => { if(baseSeleccionada){ formNuevoDato.style.display = "block"; inputValor.focus(); } };
btnCancelarDato.onclick = () => {
    formNuevoDato.style.display = "none";
    opcionesExtra.style.display = "none";
    inputNombre.value = "";
    inputValor.value = "";
    inputNegativo.checked = false;
    inputNota.value = "";
};

// --- TECLAS ---
document.addEventListener('keydown', e => {
    if(e.key === "F2"){ 
        if(!baseSeleccionada) return;
        formNuevoDato.style.display = "block";
        inputValor.focus();
        e.preventDefault();
    }
});

// Enter entre campos
[inputValor, inputNombre, inputNota].forEach((input,index,arr)=>{
    input.addEventListener('keydown', e=>{
        if(e.key==="Enter"){
            e.preventDefault();
            if(index < arr.length-1) arr[index+1].focus();
            else guardarDato();
        }
    });
});

// --- FUNCION PARA GUARDAR DATO Y AGREGARLO A LA LISTA ---
function guardarDato() {
    const nombre = inputNombre.value.trim();
    let valor = parseFloat(inputValor.value);
    const negativo = inputNegativo.checked;
    const nota = inputNota.value.trim();

    if(!nombre || isNaN(valor)){
        alert("Nombre y valor son requeridos");
        return;
    }

    if(negativo) valor = -Math.abs(valor);

    const ref = db.ref(`${idEmpresa}/basededatos/${baseSeleccionada}`);
    const newKey = ref.push().key;

    const ahora = new Date();
    const fechaHora = `${ahora.getFullYear()}-${String(ahora.getMonth()+1).padStart(2,'0')}-${String(ahora.getDate()).padStart(2,'0')} ${String(ahora.getHours()).padStart(2,'0')}:${String(ahora.getMinutes()).padStart(2,'0')}`;

    ref.child(newKey).set({
        id: newKey,
        fechaHora: fechaHora,
        nombre: nombre,
        valor: valor,
        nota: nota || ""
    }).then(() => {
         // üîπ Agregar inmediatamente a la lista visual
    const li = document.createElement('li');
    li.textContent = `${nombre} - ${valor} (${fechaHora})`;
    if (valor < 0) {
        li.style.color = '#D32F2F';
        li.style.backgroundColor = '#FFCDD2';
    } else {
        li.style.color = '#388E3C';
        li.style.backgroundColor = '#C8E6C9';
    }
    li.style.padding = '10px';
    li.style.marginBottom = '5px';
    li.style.borderRadius = '6px';

    sidebarList.insertBefore(li, sidebarList.firstChild);
        // Limpiar y ocultar formulario
        inputNombre.value = "";
        inputValor.value = "";
        inputNegativo.checked = false;
        inputNota.value = "";
        formNuevoDato.style.display = "none";
        opcionesExtra.style.display = "none";

        // Ahora, el usuario presiona F2 para agregar otro dato
    }).catch(err => alert("Error guardando dato: " + err.message));
}

function mostrarItemsConColores(items) {
    sidebarList.innerHTML = ''; // limpiar lista
    items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.nombre} - ${item.valor} (${item.fechaHora})`;

        // Colores seg√∫n valor
        if(item.valor < 0){
            li.style.color = '#D32F2F'; // rojo para negativos
            li.style.backgroundColor = '#FFCDD2'; // fondo rojo claro
        } else {
            li.style.color = '#388E3C'; // verde para positivos
            li.style.backgroundColor = '#C8E6C9'; // fondo verde claro
        }

        li.style.padding = '10px';
        li.style.marginBottom = '5px';
        li.style.borderRadius = '6px';

        sidebarList.appendChild(li);
    });
}

// --- CARGAR PEDIDOS ---
function cargarPedidos(){
    const ref = db.ref(`${idEmpresa}/Pedidos`);
    const tbody = document.querySelector("#tablaPedidos tbody");
    ref.on('value', snapshot=>{
        tbody.innerHTML='';
        snapshot.forEach(domicSnap=>{
            const idDomic = domicSnap.key;
            domicSnap.forEach(pedidoSnap=>{
                const p = pedidoSnap.val();
                const tr = document.createElement('tr');
                tr.innerHTML=`
                    <td>${idDomic}</td>
                    <td>${pedidoSnap.key}</td>
                    <td>${p.nombre||''}</td>
                    <td>${p.nota||''}</td>
                    <td>${p.valor||''}</td>
                    <td>${p.diaEntrega||''}</td>
                `;
                tbody.appendChild(tr);
            });
        });
    });
}

// --- AUTOCOMPLETADO Y ENTER PARA GUARDAR ---
const suggestionsContainer = document.createElement('div');
suggestionsContainer.id='suggestions';
suggestionsContainer.style.position='absolute';
suggestionsContainer.style.background='#fff';
suggestionsContainer.style.border='1px solid #ccc';
suggestionsContainer.style.borderRadius='6px';
suggestionsContainer.style.maxHeight='120px';
suggestionsContainer.style.overflowY='auto';
suggestionsContainer.style.zIndex='1000';
document.body.appendChild(suggestionsContainer);

function posicionarSugerencias(){
    const rect = inputNombre.getBoundingClientRect();
    suggestionsContainer.style.top = rect.bottom + window.scrollY + 'px';
    suggestionsContainer.style.left = rect.left + window.scrollX + 'px';
    suggestionsContainer.style.width = rect.width + 'px';
}

// --- AUTOCOMPLETADO INLINE (solo completa el input) ---
inputNombre.addEventListener('input', () => {
    const query = inputNombre.value.trim().toLowerCase();
    if(query.length < 2) return;

    const ref = db.ref(`${idEmpresa}/basededatos/${baseSeleccionada}`);
    ref.once('value', snapshot => {
        let primeraCoincidencia = null;
        snapshot.forEach(itemSnap => {
            const item = itemSnap.val();
            if(item && item.nombre && item.nombre.toLowerCase().startsWith(query) && !primeraCoincidencia){
                primeraCoincidencia = item.nombre;
            }
        });

        if(primeraCoincidencia){
            inputNombre.value = primeraCoincidencia;
            inputNombre.setSelectionRange(query.length, primeraCoincidencia.length);
        }
    });
});


// ENTER en Valor pasa a Nombre
inputValor.addEventListener('keydown', e=>{
    if(e.key === "Enter"){
        e.preventDefault();
        inputNombre.focus();
    }
});

// ENTER en Nombre selecciona la primera sugerencia o guarda el dato
inputNombre.addEventListener('keydown', e=>{
    if(e.key === "Enter"){
        e.preventDefault();
        if(suggestionsContainer.firstChild){
            inputNombre.value = suggestionsContainer.firstChild.textContent;
            suggestionsContainer.style.display='none';
        }
        guardarDato(); // Guardar inmediatamente sin tocar botones
    }
});

// Cerrar sugerencias al hacer clic fuera
document.addEventListener('click', (e)=>{
    if(!formNuevoDato.contains(e.target)){
        suggestionsContainer.style.display='none';
    }
});


</script>

</body>
</html>
